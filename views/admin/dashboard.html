{{define "content"}}
<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-cog"></i> Admin Dashboard</h1>
        <p>Manage the Glorp community</p>
    </div>

    <div class="admin-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-comments"></i>
            </div>
            <div class="stat-info">
                <h3>{{.TotalThreads}}</h3>
                <p>Total Threads</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-message"></i>
            </div>
            <div class="stat-info">
                <h3>{{.TotalMessages}}</h3>
                <p>Total Messages</p>
            </div>
        </div>
    </div>

    <div class="admin-sections">
        <div class="admin-section">
            <h2><i class="fas fa-list"></i> Recent Threads</h2>
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Messages</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .RecentThreads}}
                        <tr>
                            <td>
                                <a href="/threads/{{.ID}}" class="thread-link">{{.Title}}</a>
                            </td>
                            <td>{{.Author.Username}}</td>
                            <td>
                                <span class="status-badge status-{{.Status}}">
                                    {{if eq .Status "open"}}
                                        <i class="fas fa-unlock"></i>
                                    {{else if eq .Status "closed"}}
                                        <i class="fas fa-lock"></i>
                                    {{else if eq .Status "archived"}}
                                        <i class="fas fa-archive"></i>
                                    {{end}}
                                    {{.Status}}
                                </span>
                            </td>
                            <td>{{.CreatedAt.Format "Jan 02, 2006"}}</td>
                            <td>{{.MessageCount}}</td>
                            <td>
                                <div class="action-buttons">
                                    <select class="status-select" onchange="updateThreadStatus('{{.ID}}', this.value)">
                                        <option value="">Change Status</option>
                                        <option value="open" {{if eq .Status "open"}}disabled{{end}}>Open</option>
                                        <option value="closed" {{if eq .Status "closed"}}disabled{{end}}>Close</option>
                                        <option value="archived" {{if eq .Status "archived"}}disabled{{end}}>Archive</option>
                                    </select>
                                    <button onclick="deleteThread('{{.ID}}')" class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2><i class="fas fa-list-ul"></i> All Threads Management</h2>
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Threads}}
                        <tr>
                            <td>{{.ID}}</td>
                            <td>
                                <a href="/threads/{{.ID}}" class="thread-link">{{.Title}}</a>
                            </td>
                            <td>{{.Author.Username}}</td>
                            <td>
                                <span class="status-badge status-{{.Status}}">
                                    {{if eq .Status "open"}}
                                        <i class="fas fa-unlock"></i>
                                    {{else if eq .Status "closed"}}
                                        <i class="fas fa-lock"></i>
                                    {{else if eq .Status "archived"}}
                                        <i class="fas fa-archive"></i>
                                    {{end}}
                                    {{.Status}}
                                </span>
                            </td>
                            <td>{{.CreatedAt.Format "Jan 02, 2006"}}</td>
                            <td>
                                <div class="action-buttons">
                                    <select class="status-select" onchange="updateThreadStatus('{{.ID}}', this.value)">
                                        <option value="">Change Status</option>
                                        <option value="open" {{if eq .Status "open"}}disabled{{end}}>Open</option>
                                        <option value="closed" {{if eq .Status "closed"}}disabled{{end}}>Close</option>
                                        <option value="archived" {{if eq .Status "archived"}}disabled{{end}}>Archive</option>
                                    </select>
                                    <button onclick="deleteThread('{{.ID}}')" class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button onclick="banUser('{{.AuthorID}}', '{{.Author.Username}}')" class="btn btn-sm btn-warning">
                                        <i class="fas fa-ban"></i> Ban User
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
async function updateThreadStatus(threadId, status) {
    if (!status) return;
    
    const confirmMessage = `Are you sure you want to ${status} this thread?`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/threads/${threadId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status })
        });
        
        if (response.ok) {
            location.reload(); // Refresh to show updated status
        } else {
            const result = await response.text();
            alert('Failed to update thread status: ' + result);
        }
    } catch (error) {
        alert('Failed to update thread status. Please try again.');
    }
}

async function deleteThread(threadId) {
    if (!confirm('Are you sure you want to delete this thread? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/threads/${threadId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload(); // Refresh to remove deleted thread
        } else {
            const result = await response.text();
            alert('Failed to delete thread: ' + result);
        }
    } catch (error) {
        alert('Failed to delete thread. Please try again.');
    }
}

async function banUser(userId, username) {
    const action = confirm(`Are you sure you want to ban user "${username}"?`) ? 'ban' : null;
    if (!action) return;
    
    try {
        const response = await fetch(`/api/admin/ban/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action })
        });
        
        if (response.ok) {
            alert(`User "${username}" has been banned successfully.`);
            location.reload();
        } else {
            const result = await response.text();
            alert('Failed to ban user: ' + result);
        }
    } catch (error) {
        alert('Failed to ban user. Please try again.');
    }
}
</script>
{{end}}