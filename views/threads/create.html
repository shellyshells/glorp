{{define "content"}}
<div class="create-post-container">
    <div class="create-post-card">
        <div class="create-post-header">
            <h2>Create a post</h2>
        </div>

        <div class="post-type-tabs">
            <button class="post-type-tab active" data-type="text">
                <i class="fas fa-file-alt"></i> Text
            </button>
            <button class="post-type-tab" data-type="link">
                <i class="fas fa-link"></i> Link
            </button>
            <button class="post-type-tab" data-type="image">
                <i class="fas fa-image"></i> Image
            </button>
        </div>

        <form id="create-post-form" class="create-post-form">
            <div class="form-row">
                <div class="community-selector">
                    <select class="community-select" required>
                        <option value="">Choose a community</option>
                        <option value="general">r/General</option>
                        <option value="technology">r/Technology</option>
                        <option value="programming">r/Programming</option>
                        <option value="help">r/Help</option>
                        <option value="discussion">r/Discussion</option>
                        <option value="news">r/News</option>
                    </select>
                </div>
            </div>

            <input 
                type="text" 
                class="title-input" 
                placeholder="Title" 
                name="title" 
                required 
                maxlength="200"
            >

            <div class="content-area" id="text-content">
                <textarea 
                    class="content-textarea" 
                    placeholder="Text (optional)"
                    name="description"
                    rows="8"
                ></textarea>
            </div>

            <div class="content-area" id="link-content" style="display: none;">
                <input 
                    type="url" 
                    class="title-input" 
                    placeholder="Url" 
                    name="link_url"
                    style="margin: 16px; width: calc(100% - 32px);"
                >
            </div>

            <div class="content-area" id="image-content" style="display: none;">
                <div style="padding: 40px; text-align: center; border: 2px dashed #ddd; margin: 16px;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                    <p style="color: #878a8c; margin-bottom: 16px;">Drag and drop images or video here</p>
                    <input type="file" accept="image/*" style="display: none;" id="image-upload">
                    <button type="button" class="btn btn-outline" onclick="document.getElementById('image-upload').click()">
                        Upload
                    </button>
                </div>
            </div>

            <div class="tag-section">
                <label>Add tags to help people find your post:</label>
                <div class="tag-grid">
                    {{range .Tags}}
                    <div class="tag-option" onclick="toggleTag(this)">
                        <input type="checkbox" name="tags" value="{{.ID}}" id="tag-{{.ID}}">
                        <label for="tag-{{.ID}}">{{.Name}}</label>
                    </div>
                    {{end}}
                </div>
            </div>

            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>

            <div class="post-actions">
                <div class="post-actions-left">
                    <button type="button" class="action-btn">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button type="button" class="action-btn">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                </div>
                <div class="post-actions-right">
                    <button type="submit" class="post-submit-btn">
                        <i class="fas fa-paper-plane"></i> Post
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Post type tab switching
document.querySelectorAll('.post-type-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        // Remove active class from all tabs
        document.querySelectorAll('.post-type-tab').forEach(t => t.classList.remove('active'));
        
        // Add active class to clicked tab
        this.classList.add('active');
        
        // Hide all content areas
        document.getElementById('text-content').style.display = 'none';
        document.getElementById('link-content').style.display = 'none';
        document.getElementById('image-content').style.display = 'none';
        
        // Show corresponding content area
        const type = this.dataset.type;
        document.getElementById(type + '-content').style.display = 'block';
    });
});

// Tag selection
function toggleTag(tagElement) {
    const checkbox = tagElement.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    tagElement.classList.toggle('selected', checkbox.checked);
}

// Initialize tag states
document.querySelectorAll('.tag-option input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        this.closest('.tag-option').classList.toggle('selected', this.checked);
    });
});

// Character counter for title
const titleInput = document.querySelector('.title-input');
titleInput.addEventListener('input', function() {
    const remaining = 200 - this.value.length;
    // You can add a character counter here if needed
});

// Form submission
document.getElementById('create-post-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const selectedTags = Array.from(formData.getAll('tags')).map(id => parseInt(id));
    
    // Get the active post type
    const activeTab = document.querySelector('.post-type-tab.active');
    const postType = activeTab.dataset.type;
    
    let description = '';
    
    if (postType === 'text') {
        description = formData.get('description') || '';
    } else if (postType === 'link') {
        const linkUrl = formData.get('link_url');
        if (linkUrl) {
            description = `Link: ${linkUrl}`;
        }
    }
    
    const data = {
        title: formData.get('title'),
        description: description,
        tags: selectedTags,
        post_type: postType
    };
    
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    const submitBtn = document.querySelector('.post-submit-btn');
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Posting...';
    
    try {
        const response = await fetch('/api/threads', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            successDiv.textContent = 'Post created successfully! Redirecting...';
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            
            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = `/threads/${result.thread.id}`;
            }, 1500);
        } else {
            const result = await response.text();
            errorDiv.textContent = result;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }
    } catch (error) {
        errorDiv.textContent = 'Failed to create post. Please try again.';
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
        console.error('Error creating post:', error);
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post';
    }
});

// Auto-resize textarea
const textarea = document.querySelector('.content-textarea');
if (textarea) {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.max(120, this.scrollHeight) + 'px';
    });
}

// Image upload preview (for future enhancement)
document.getElementById('image-upload')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // You can add image preview functionality here
            console.log('Image selected:', file.name);
        };
        reader.readAsDataURL(file);
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter to submit
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('create-post-form').dispatchEvent(new Event('submit'));
    }
});
</script>
{{end}}