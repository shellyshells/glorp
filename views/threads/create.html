{{define "content"}}
<div class="create-post-container">
    <div class="create-post-card">
        <div class="create-post-header">
            <h2>Create a post</h2>
        </div>

        <div class="post-type-tabs">
            <button class="post-type-tab active" data-type="text">
                <i class="fas fa-file-alt"></i> Text
            </button>
            <button class="post-type-tab" data-type="link">
                <i class="fas fa-link"></i> Link
            </button>
            <button class="post-type-tab" data-type="image">
                <i class="fas fa-image"></i> Image
            </button>
        </div>

        <form id="create-post-form" class="create-post-form">
            <input 
                type="text" 
                class="title-input" 
                placeholder="Title" 
                name="title" 
                required 
                maxlength="200"
            >

            <div class="content-area" id="text-content">
                <textarea 
                    class="content-textarea" 
                    placeholder="Text (optional)"
                    name="description"
                    rows="8"
                ></textarea>
            </div>

            <div class="content-area" id="link-content" style="display: none;">
                <input 
                    type="url" 
                    class="link-input" 
                    placeholder="Paste your link here" 
                    name="link_url"
                >
                <textarea 
                    class="content-textarea" 
                    placeholder="Description (optional)"
                    name="link_description"
                    rows="4"
                ></textarea>
            </div>

            <div class="content-area" id="image-content" style="display: none;">
                <div class="image-upload-section">
                    <div class="upload-area" id="upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag and drop images here or click to upload</p>
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('image-upload').click()">
                            Choose Image
                        </button>
                        <input type="file" accept="image/*" id="image-upload" style="display: none;">
                        <small>Max 10MB • JPG, PNG, GIF, WEBP</small>
                    </div>
                    
                    <div class="image-preview-section" id="image-preview-section" style="display: none;">
                        <div class="image-preview-container">
                            <img id="image-preview" src="" alt="Preview">
                            <div class="image-actions">
                                <button type="button" class="btn btn-sm btn-outline" onclick="removeImage()">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                                <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('image-upload').click()">
                                    <i class="fas fa-edit"></i> Change
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <textarea 
                        class="content-textarea" 
                        placeholder="Description (optional)"
                        name="image_description"
                        rows="4"
                    ></textarea>
                </div>
            </div>

            <div class="tag-section">
                <label>Add tags to help people find your post:</label>
                <div class="tag-grid">
                    {{range .Tags}}
                    <div class="tag-option" onclick="toggleTag(this)">
                        <input type="checkbox" name="tags" value="{{.ID}}" id="tag-{{.ID}}">
                        <label for="tag-{{.ID}}">{{.Name}}</label>
                    </div>
                    {{end}}
                </div>
            </div>

            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>

            <div class="post-actions">
                <div class="post-actions-left">
                    <button type="button" class="action-btn" onclick="previewPost()">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
                <div class="post-actions-right">
                    <button type="submit" class="post-submit-btn">
                        <i class="fas fa-paper-plane"></i> Post
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
let currentPostType = 'text';
let uploadedImageUrl = '';
let isUploading = false;

// Post type tab switching
document.querySelectorAll('.post-type-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        // Remove active class from all tabs
        document.querySelectorAll('.post-type-tab').forEach(t => t.classList.remove('active'));
        
        // Add active class to clicked tab
        this.classList.add('active');
        
        // Hide all content areas
        document.getElementById('text-content').style.display = 'none';
        document.getElementById('link-content').style.display = 'none';
        document.getElementById('image-content').style.display = 'none';
        
        // Show corresponding content area
        const type = this.dataset.type;
        currentPostType = type;
        document.getElementById(type + '-content').style.display = 'block';
        
        // Reset upload state when switching away from image
        if (type !== 'image') {
            resetImageUpload();
        }
    });
});

// Tag selection
function toggleTag(tagElement) {
    const checkbox = tagElement.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    tagElement.classList.toggle('selected', checkbox.checked);
}

// Initialize tag states
document.querySelectorAll('.tag-option input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        this.closest('.tag-option').classList.toggle('selected', this.checked);
    });
});

// Image upload functionality
const imageUpload = document.getElementById('image-upload');
const uploadArea = document.getElementById('upload-area');
const imagePreviewSection = document.getElementById('image-preview-section');
const imagePreview = document.getElementById('image-preview');

// Handle file selection
imageUpload.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        handleImageUpload(file);
    }
});

// Drag and drop functionality
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
            imageUpload.files = files;
            handleImageUpload(file);
        } else {
            showError('Please select an image file (JPG, PNG, GIF, WEBP)');
        }
    }
});

// Handle image upload
async function handleImageUpload(file) {
    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        showError('File size must be less than 10MB');
        return;
    }

    // Validate file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
        showError('Please select a valid image file (JPG, PNG, GIF, WEBP)');
        return;
    }

    isUploading = true;
    updateUploadArea('Uploading...', true);

    try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/api/upload/image', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            uploadedImageUrl = result.url;
            showImagePreview(result.url);
            showSuccess('Image uploaded successfully!');
        } else {
            const error = await response.text();
            showError('Upload failed: ' + error);
            resetImageUpload();
        }
    } catch (error) {
        console.error('Upload error:', error);
        showError('Upload failed. Please try again.');
        resetImageUpload();
    } finally {
        isUploading = false;
    }
}

function updateUploadArea(text, loading = false) {
    const uploadArea = document.getElementById('upload-area');
    const icon = loading ? 'fas fa-spinner fa-spin' : 'fas fa-cloud-upload-alt';
    
    uploadArea.innerHTML = `
        <i class="${icon}"></i>
        <p>${text}</p>
        ${!loading ? '<button type="button" class="btn btn-outline" onclick="document.getElementById(\'image-upload\').click()">Choose Image</button>' : ''}
        <small>Max 10MB • JPG, PNG, GIF, WEBP</small>
    `;
}

function showImagePreview(imageUrl) {
    imagePreview.src = imageUrl;
    uploadArea.style.display = 'none';
    imagePreviewSection.style.display = 'block';
}

function removeImage() {
    uploadedImageUrl = '';
    resetImageUpload();
}

function resetImageUpload() {
    uploadArea.style.display = 'block';
    imagePreviewSection.style.display = 'none';
    imageUpload.value = '';
    updateUploadArea('Drag and drop images here or click to upload');
}

// Preview functionality
function previewPost() {
    const title = document.querySelector('.title-input').value;
    const selectedTags = Array.from(document.querySelectorAll('.tag-option.selected label')).map(label => label.textContent);
    
    let content = '';
    let previewData = {
        title: title || 'Untitled Post',
        type: currentPostType,
        tags: selectedTags
    };
    
    switch(currentPostType) {
        case 'text':
            content = document.querySelector('textarea[name="description"]').value;
            previewData.content = content || 'No content';
            break;
        case 'link':
            const linkUrl = document.querySelector('input[name="link_url"]').value;
            const linkDesc = document.querySelector('textarea[name="link_description"]').value;
            previewData.linkUrl = linkUrl;
            previewData.content = linkDesc || 'No description';
            break;
        case 'image':
            const imageDesc = document.querySelector('textarea[name="image_description"]').value;
            previewData.imageUrl = uploadedImageUrl;
            previewData.content = imageDesc || 'No description';
            break;
    }
    
    // Simple preview modal (you can enhance this)
    const previewModal = document.createElement('div');
    previewModal.className = 'preview-modal';
    previewModal.innerHTML = `
        <div class="preview-content">
            <div class="preview-header">
                <h3>Post Preview</h3>
                <button onclick="this.closest('.preview-modal').remove()">&times;</button>
            </div>
            <div class="preview-body">
                <h2>${previewData.title}</h2>
                <div class="preview-tags">
                    ${previewData.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>
                <div class="preview-type">${previewData.type.toUpperCase()} POST</div>
                ${previewData.linkUrl ? `<div class="preview-link"><strong>Link:</strong> ${previewData.linkUrl}</div>` : ''}
                ${previewData.imageUrl ? `<div class="preview-image"><img src="${previewData.imageUrl}" alt="Preview" style="max-width: 100%; height: auto; border-radius: 4px;"></div>` : ''}
                <div class="preview-content-text">${previewData.content}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(previewModal);
}

// Form submission
document.getElementById('create-post-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isUploading) {
        showError('Please wait for image upload to complete');
        return;
    }
    
    const formData = new FormData(this);
    const selectedTags = Array.from(formData.getAll('tags')).map(id => parseInt(id));
    
    let description = '';
    let imageUrl = '';
    let linkUrl = '';
    
    switch(currentPostType) {
        case 'text':
            description = formData.get('description') || '';
            break;
        case 'link':
            linkUrl = formData.get('link_url') || '';
            description = formData.get('link_description') || '';
            break;
        case 'image':
            imageUrl = uploadedImageUrl;
            description = formData.get('image_description') || '';
            break;
    }
    
    const data = {
        title: formData.get('title'),
        description: description,
        tags: selectedTags,
        post_type: currentPostType,
        image_url: imageUrl,
        link_url: linkUrl
    };
    
    const submitBtn = document.querySelector('.post-submit-btn');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Posting...';
    
    try {
        const response = await fetch('/api/threads', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            showSuccess('Post created successfully! Redirecting...');
            
            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = `/threads/${result.thread.id}`;
            }, 1500);
        } else {
            const result = await response.text();
            showError(result);
        }
    } catch (error) {
        showError('Failed to create post. Please try again.');
        console.error('Error creating post:', error);
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// Utility functions
function showError(message) {
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    successDiv.style.display = 'none';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    errorDiv.style.display = 'none';
}

// Auto-resize textarea
document.querySelectorAll('.content-textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.max(120, this.scrollHeight) + 'px';
    });
});

// Character counter for title
const titleInput = document.querySelector('.title-input');
titleInput.addEventListener('input', function() {
    const remaining = 200 - this.value.length;
    // You can add a character counter display here if needed
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter to submit
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('create-post-form').dispatchEvent(new Event('submit'));
    }
});
</script>

<style>
/* Enhanced styles for image upload */
.image-upload-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.upload-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #fafafa;
}

.upload-area:hover,
.upload-area.drag-over {
    border-color: #0079d3;
    background: #f0f8ff;
}

.upload-area i {
    font-size: 48px;
    color: #ccc;
    margin-bottom: 16px;
    display: block;
}

.upload-area p {
    color: #878a8c;
    margin-bottom: 16px;
    font-size: 16px;
}

.upload-area small {
    color: #999;
    font-size: 12px;
    display: block;
    margin-top: 8px;
}

.image-preview-section {
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.image-preview-container {
    position: relative;
}

#image-preview {
    width: 100%;
    max-height: 400px;
    object-fit: contain;
    display: block;
}

.image-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 8px;
}

.image-actions .btn {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.link-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #edeff1;
    border-radius: 4px;
    font-size: 14px;
    margin-bottom: 12px;
    transition: border-color 0.2s;
}

.link-input:focus {
    outline: none;
    border-color: #0079d3;
}

/* Preview modal styles */
.preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.preview-content {
    background: white;
    border-radius: 8px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #edeff1;
}

.preview-header h3 {
    margin: 0;
    color: #1a1a1b;
}

.preview-header button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #878a8c;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
}

.preview-header button:hover {
    background: #f6f7f8;
}

.preview-body {
    padding: 20px;
}

.preview-body h2 {
    margin: 0 0 12px 0;
    color: #1a1a1b;
}

.preview-tags {
    margin-bottom: 12px;
}

.preview-tags .tag {
    display: inline-block;
    background: #f6f7f8;
    color: #0079d3;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 6px;
}

.preview-type {
    background: #0079d3;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    display: inline-block;
    margin-bottom: 12px;
}

.preview-link {
    background: #f6f7f8;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 12px;
    word-break: break-all;
}

.preview-image {
    margin-bottom: 12px;
}

.preview-content-text {
    color: #1a1a1b;
    line-height: 1.5;
    white-space: pre-wrap;
}

/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Mobile responsive */
@media (max-width: 768px) {
    .upload-area {
        padding: 30px 15px;
    }
    
    .upload-area i {
        font-size: 36px;
    }
    
    .image-actions {
        position: static;
        justify-content: center;
        padding: 8px;
        background: rgba(0, 0, 0, 0.05);
    }
    
    .preview-content {
        width: 95%;
    }
    
    .preview-body {
        padding: 16px;
    }
}
</style>
{{end}}