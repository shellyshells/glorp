{{define "content"}}
<div class="thread-container">
    <div class="thread-card">
        <div class="thread-content-wrapper">
            <div class="thread-vote-section">
                {{if .User}}
                    <button class="vote-arrow {{if eq .Thread.UserVote 1}}upvoted{{end}}" onclick="voteThread('{{.Thread.ID}}', 1)" title="Upvote">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                {{else}}
                    <a href="/login" class="vote-arrow" title="Login to vote">
                        <i class="fas fa-arrow-up"></i>
                    </a>
                {{end}}
                
                <div class="vote-score" id="thread-score">{{.Thread.Score}}</div>
                
                {{if .User}}
                    <button class="vote-arrow {{if eq .Thread.UserVote -1}}downvoted{{end}}" onclick="voteThread('{{.Thread.ID}}', -1)" title="Downvote">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                {{else}}
                    <a href="/login" class="vote-arrow" title="Login to vote">
                        <i class="fas fa-arrow-down"></i>
                    </a>
                {{end}}
            </div>
            
            <div class="thread-main-content">
                <div class="thread-meta-line">
                    {{range .Thread.Tags}}
                        <a href="/?tag={{.Name}}" class="community-link">z/{{.Name}}</a>
                    {{end}}
                    <span>â€¢</span>
                    <span>Posted by 
                        <div class="inline-user-info">
                            <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Thread.Author)}}">
                                {{if .Thread.Author.AvatarURL}}
                                    <img src="{{.Thread.Author.AvatarURL}}" alt="{{.Thread.Author.Username}}" class="avatar-img">
                                {{else}}
                                    <span class="avatar-initial">{{getUserInitial .Thread.Author}}</span>
                                {{end}}
                                {{if isUserOnline .Thread.Author}}
                                    <div class="online-indicator"></div>
                                {{end}}
                            </div>
                            <a href="/user/{{.Thread.Author.Username}}" class="user-link">u/{{.Thread.Author.Username}}</a>
                        </div>
                    </span>
                    <span>â€¢</span>
                    <span title="{{.Thread.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .Thread.CreatedAt}}</span>
                    {{if eq .Thread.Status "closed"}}
                        <span class="status-badge">ðŸ”’ Closed</span>
                    {{end}}
                    {{if ne .Thread.PostType "text"}}
                        <span class="post-type-badge post-type-{{.Thread.PostType}}">
                            {{if eq .Thread.PostType "image"}}ðŸ“·{{else if eq .Thread.PostType "link"}}ðŸ”—{{end}}
                            {{upper .Thread.PostType}}
                        </span>
                    {{end}}
                </div>
                
                <h1 class="thread-title">{{.Thread.Title}}</h1>
                
                {{/* Display content based on post type */}}
                {{if eq .Thread.PostType "image"}}
                    {{if .Thread.ImageURL}}
                    <div class="thread-image-container">
                        <img src="{{.Thread.ImageURL}}" alt="{{.Thread.Title}}" class="thread-image" onclick="openImageModal(this.src)">
                    </div>
                    {{end}}
                    {{if .Thread.Description}}
                    <div class="thread-description">
                        <p>{{.Thread.Description}}</p>
                    </div>
                    {{end}}
                {{else if eq .Thread.PostType "link"}}
                    {{if .Thread.LinkURL}}
                    <div class="thread-link-container">
                        <div class="link-preview">
                            <div class="link-info">
                                <i class="fas fa-external-link-alt"></i>
                                <span class="link-domain">{{.Thread.LinkURL}}</span>
                            </div>
                            <a href="{{.Thread.LinkURL}}" target="_blank" rel="noopener noreferrer" class="link-button">
                                Visit Link <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    {{end}}
                    {{if .Thread.Description}}
                    <div class="thread-description">
                        <p>{{.Thread.Description}}</p>
                    </div>
                    {{end}}
                {{else}}
                    {{/* Text post */}}
                    {{if .Thread.Description}}
                    <div class="thread-description">
                        <p>{{.Thread.Description}}</p>
                    </div>
                    {{end}}
                {{end}}
                
                <div class="thread-footer">
                    <div class="thread-action">
                        <i class="fas fa-comment"></i>
                        <span>{{.Thread.MessageCount}} {{pluralize .Thread.MessageCount "comment" "comments"}}</span>
                    </div>
                    
                    <div class="thread-action" onclick="shareThread('{{.Thread.ID}}'); return false;">
                        <i class="fas fa-share"></i> Share
                    </div>

                    {{if or (eq .User.ID .Thread.AuthorID) (eq .User.Role "admin")}}
                    <a href="/threads/{{.Thread.ID}}/edit" class="thread-action">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    {{end}}
                    {{if or (eq .User.ID .Thread.AuthorID) (eq .User.Role "admin")}}
                    <a href="#" class="thread-action thread-action-danger" onclick="deleteThread('{{.Thread.ID}}'); return false;">
                        <i class="fas fa-trash-alt"></i> Delete
                    </a>
                    {{end}}
                </div>
            </div>
        </div>
    </div>

    <div class="comments-section">
        <div class="comments-header">
            <div class="comments-sort">
                <label>Sort by:</label>
                <select id="sort-select" onchange="updateSort(this.value)">
                    <option value="date" {{if eq .SortBy "date"}}selected{{end}}>Best</option>
                    <option value="popularity" {{if eq .SortBy "popularity"}}selected{{end}}>Top</option>
                    <option value="new" {{if eq .SortBy "new"}}selected{{end}}>New</option>
                </select>
            </div>
        </div>

        {{if .User}}
            {{if ne .Thread.Status "closed"}}
            <div class="comment-form-container">
                <div class="comment-form-header">
                    <div class="comment-as-user">
                        <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .User)}}">
                            {{if .User.AvatarURL}}
                                <img src="{{.User.AvatarURL}}" alt="{{.User.Username}}" class="avatar-img">
                            {{else}}
                                <span class="avatar-initial">{{getUserInitial .User}}</span>
                            {{end}}
                        </div>
                        <span>Comment as <strong>u/{{.User.Username}}</strong></span>
                    </div>
                </div>
                <form id="comment-form" class="comment-form">
                    <div class="comment-input-area">
                        <textarea id="comment-content" name="content" placeholder="What are your thoughts?" required></textarea>
                    </div>
                    <div class="comment-form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-comment"></i> Comment
                        </button>
                    </div>
                    <div id="comment-error" class="error-message" style="display: none;"></div>
                </form>
            </div>
            {{else}}
                <div class="closed-notice">
                    <i class="fas fa-lock"></i> This thread is locked and no longer accepts new comments.
                </div>
            {{end}}
        {{else}}
            <div class="login-prompt">
                <p>Log in or sign up to leave a comment</p>
                <div class="auth-buttons">
                    <a href="/login" class="btn btn-outline">Log In</a>
                    <a href="/register" class="btn btn-primary">Sign Up</a>
                </div>
            </div>
        {{end}}

        <div class="comments-list" id="comments-list">
            {{if .Messages}}
                {{range .Messages}}
                <div class="comment-item" data-comment-id="{{.ID}}">
                    <div class="comment-vote-section">
                        {{if $.User}}
                            <button class="comment-vote-btn {{if eq .UserVote 1}}upvoted{{end}}" onclick="voteComment('{{.ID}}', 1)">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        {{else}}
                            <a href="/login" class="comment-vote-btn" title="Login to vote">
                                <i class="fas fa-arrow-up"></i>
                            </a>
                        {{end}}
                        
                        <span class="comment-score">{{.Score}}</span>
                        
                        {{if $.User}}
                            <button class="comment-vote-btn {{if eq .UserVote -1}}downvoted{{end}}" onclick="voteComment('{{.ID}}', -1)">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        {{else}}
                            <a href="/login" class="comment-vote-btn" title="Login to vote">
                                <i class="fas fa-arrow-down"></i>
                            </a>
                        {{end}}
                    </div>
                    
                    <div class="comment-content-section">
                        <div class="comment-header">
                            <div class="comment-author-info">
                                <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Author)}}">
                                    {{if .Author.AvatarURL}}
                                        <img src="{{.Author.AvatarURL}}" alt="{{.Author.Username}}" class="avatar-img">
                                    {{else}}
                                        <span class="avatar-initial">{{getUserInitial .Author}}</span>
                                    {{end}}
                                    {{if isUserOnline .Author}}
                                        <div class="online-indicator"></div>
                                    {{end}}
                                </div>
                                <a href="/user/{{.Author.Username}}" class="comment-author">u/{{.Author.Username}}</a>
                            </div>
                            <span class="comment-score-inline">{{.Score}} points</span>
                            <span class="comment-time" title="{{.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .CreatedAt}}</span>
                        </div>
                        
                        <div class="comment-content">
                            <p>{{.Content}}</p>
                        </div>
                        
                        <div class="comment-actions">
                            {{if $.User}}
                                <button class="comment-action-btn" onclick="toggleReplyForm('{{.ID}}')">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                            {{end}}
                            
                            <button class="comment-action-btn" onclick="shareComment('{{.ID}}')">
                                <i class="fas fa-share"></i> Share
                            </button>
                            
                            {{if and (.Replies) (gt (len .Replies) 0)}}
                                <button class="comment-action-btn toggle-replies-btn" onclick="toggleReplies('{{.ID}}')" data-expanded="true">
                                    <i class="fas fa-chevron-up"></i>
                                    <span class="toggle-text">Hide {{len .Replies}} {{if eq (len .Replies) 1}}reply{{else}}replies{{end}}</span>
                                </button>
                            {{end}}
                            
                            {{if $.User}}
                                {{if or (eq $.User.ID .AuthorID) (eq $.User.Role "admin")}}
                                <button class="comment-action-btn danger" onclick="deleteComment('{{.ID}}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                {{end}}
                            {{end}}
                        </div>
                        
                        <!-- Reply form (hidden by default) -->
                        {{if $.User}}
                        <div class="reply-form" id="reply-form-{{.ID}}" style="display: none;">
                            <div class="reply-form-header">
                                <div class="reply-as-user">
                                    <div class="user-avatar-small {{getAvatarClass (getAvatarStyle $.User)}}">
                                        {{if $.User.AvatarURL}}
                                            <img src="{{$.User.AvatarURL}}" alt="{{$.User.Username}}" class="avatar-img">
                                        {{else}}
                                            <span class="avatar-initial">{{getUserInitial $.User}}</span>
                                        {{end}}
                                    </div>
                                    <span>Reply as <strong>u/{{$.User.Username}}</strong></span>
                                </div>
                            </div>
                            <form onsubmit="submitReply(event, '{{.ID}}')">
                                <textarea placeholder="What are your thoughts?" required></textarea>
                                <div class="reply-form-actions">
                                    <button type="button" onclick="cancelReply('{{.ID}}')" class="btn btn-outline btn-sm">Cancel</button>
                                    <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                                </div>
                            </form>
                        </div>
                        {{end}}

                        <!-- Nested Replies -->
                        {{if .Replies}}
                        <div class="nested-replies" id="replies-{{.ID}}">
                            {{range .Replies}}
                            <div class="comment-item nested-comment" data-comment-id="{{.ID}}" data-level="{{.Level}}">
                                <div class="comment-vote-section">
                                    {{if $.User}}
                                        <button class="comment-vote-btn {{if eq .UserVote 1}}upvoted{{end}}" onclick="voteComment('{{.ID}}', 1)">
                                            <i class="fas fa-arrow-up"></i>
                                        </button>
                                    {{else}}
                                        <a href="/login" class="comment-vote-btn" title="Login to vote">
                                            <i class="fas fa-arrow-up"></i>
                                        </a>
                                    {{end}}
                                    
                                    <span class="comment-score">{{.Score}}</span>
                                    
                                    {{if $.User}}
                                        <button class="comment-vote-btn {{if eq .UserVote -1}}downvoted{{end}}" onclick="voteComment('{{.ID}}', -1)">
                                            <i class="fas fa-arrow-down"></i>
                                        </button>
                                    {{else}}
                                        <a href="/login" class="comment-vote-btn" title="Login to vote">
                                            <i class="fas fa-arrow-down"></i>
                                        </a>
                                    {{end}}
                                </div>
                                
                                <div class="comment-content-section">
                                    <div class="comment-header">
                                        <div class="comment-author-info">
                                            <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Author)}}">
                                                {{if .Author.AvatarURL}}
                                                    <img src="{{.Author.AvatarURL}}" alt="{{.Author.Username}}" class="avatar-img">
                                                {{else}}
                                                    <span class="avatar-initial">{{getUserInitial .Author}}</span>
                                                {{end}}
                                                {{if isUserOnline .Author}}
                                                    <div class="online-indicator"></div>
                                                {{end}}
                                            </div>
                                            <a href="/user/{{.Author.Username}}" class="comment-author">u/{{.Author.Username}}</a>
                                        </div>
                                        <span class="comment-score-inline">{{.Score}} points</span>
                                        <span class="comment-time" title="{{.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .CreatedAt}}</span>
                                    </div>
                                    
                                    <div class="comment-content">
                                        <p>{{.Content}}</p>
                                    </div>
                                    
                                    <div class="comment-actions">
                                        {{if $.User}}
                                            <button class="comment-action-btn" onclick="toggleReplyForm('{{.ID}}')">
                                                <i class="fas fa-reply"></i> Reply
                                            </button>
                                        {{end}}
                                        
                                        <button class="comment-action-btn" onclick="shareComment('{{.ID}}')">
                                            <i class="fas fa-share"></i> Share
                                        </button>
                                        
                                        {{if $.User}}
                                            {{if or (eq $.User.ID .AuthorID) (eq $.User.Role "admin")}}
                                            <button class="comment-action-btn danger" onclick="deleteComment('{{.ID}}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                            {{end}}
                                        {{end}}
                                    </div>
                                    
                                    <!-- Reply form (hidden by default) -->
                                    {{if $.User}}
                                    <div class="reply-form" id="reply-form-{{.ID}}" style="display: none;">
                                        <div class="reply-form-header">
                                            <div class="reply-as-user">
                                                <div class="user-avatar-small {{getAvatarClass (getAvatarStyle $.User)}}">
                                                    {{if $.User.AvatarURL}}
                                                        <img src="{{$.User.AvatarURL}}" alt="{{$.User.Username}}" class="avatar-img">
                                                    {{else}}
                                                        <span class="avatar-initial">{{getUserInitial $.User}}</span>
                                                    {{end}}
                                                </div>
                                                <span>Reply as <strong>u/{{$.User.Username}}</strong></span>
                                            </div>
                                        </div>
                                        <form onsubmit="submitReply(event, '{{.ID}}')">
                                            <textarea placeholder="What are your thoughts?" required></textarea>
                                            <div class="reply-form-actions">
                                                <button type="button" onclick="cancelReply('{{.ID}}')" class="btn btn-outline btn-sm">Cancel</button>
                                                <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                                            </div>
                                        </form>
                                    </div>
                                    {{end}}

                                    <!-- Nested Replies -->
                                    {{if .Replies}}
                                    <div class="nested-replies" id="replies-{{.ID}}">
                                        {{range .Replies}}
                                        <div class="comment-item nested-comment" data-comment-id="{{.ID}}" data-level="{{.Level}}">
                                            <div class="comment-vote-section">
                                                {{if $.User}}
                                                    <button class="comment-vote-btn {{if eq .UserVote 1}}upvoted{{end}}" onclick="voteComment('{{.ID}}', 1)">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                {{else}}
                                                    <a href="/login" class="comment-vote-btn" title="Login to vote">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </a>
                                                {{end}}
                                                
                                                <span class="comment-score">{{.Score}}</span>
                                                
                                                {{if $.User}}
                                                    <button class="comment-vote-btn {{if eq .UserVote -1}}downvoted{{end}}" onclick="voteComment('{{.ID}}', -1)">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </button>
                                                {{else}}
                                                    <a href="/login" class="comment-vote-btn" title="Login to vote">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </a>
                                                {{end}}
                                            </div>
                                            
                                            <div class="comment-content-section">
                                                <div class="comment-header">
                                                    <div class="comment-author-info">
                                                        <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Author)}}">
                                                            {{if .Author.AvatarURL}}
                                                                <img src="{{.Author.AvatarURL}}" alt="{{.Author.Username}}" class="avatar-img">
                                                            {{else}}
                                                                <span class="avatar-initial">{{getUserInitial .Author}}</span>
                                                            {{end}}
                                                            {{if isUserOnline .Author}}
                                                                <div class="online-indicator"></div>
                                                            {{end}}
                                                        </div>
                                                        <a href="/user/{{.Author.Username}}" class="comment-author">u/{{.Author.Username}}</a>
                                                    </div>
                                                    <span class="comment-score-inline">{{.Score}} points</span>
                                                    <span class="comment-time" title="{{.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .CreatedAt}}</span>
                                                </div>
                                                
                                                <div class="comment-content">
                                                    <p>{{.Content}}</p>
                                                </div>
                                                
                                                <div class="comment-actions">
                                                    {{if $.User}}
                                                        <button class="comment-action-btn" onclick="toggleReplyForm('{{.ID}}')">
                                                            <i class="fas fa-reply"></i> Reply
                                                        </button>
                                                    {{end}}
                                                    
                                                    <button class="comment-action-btn" onclick="shareComment('{{.ID}}')">
                                                        <i class="fas fa-share"></i> Share
                                                    </button>
                                                    
                                                    {{if $.User}}
                                                        {{if or (eq $.User.ID .AuthorID) (eq $.User.Role "admin")}}
                                                        <button class="comment-action-btn danger" onclick="deleteComment('{{.ID}}')">
                                                            <i class="fas fa-trash"></i> Delete
                                                        </button>
                                                        {{end}}
                                                    {{end}}
                                                </div>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                </div>
                            </div>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}
            {{else}}
                <div class="empty-comments">
                    <i class="fas fa-comment-slash"></i>
                    <h3>No comments yet</h3>
                    <p>Be the first to share what you think!</p>
                </div>
            {{end}}
        </div>

        {{if gt .Pagination.TotalPages 1}}
        <div class="pagination">
            {{if .Pagination.HasPrev}}
                <a href="?page={{sub .Pagination.CurrentPage 1}}{{if .SortBy}}&sort={{.SortBy}}{{end}}" class="pagination-btn">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            {{end}}
            
            <span class="pagination-info">
                Page {{.Pagination.CurrentPage}} of {{.Pagination.TotalPages}}
            </span>
            
            {{if .Pagination.HasNext}}
                <a href="?page={{add .Pagination.CurrentPage 1}}{{if .SortBy}}&sort={{.SortBy}}{{end}}" class="pagination-btn">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            {{end}}
        </div>
        {{end}}
    </div>
</div>

<!-- Enhanced Share Modal -->
<div id="share-modal" class="share-modal" style="display: none;">
    <div class="share-modal-overlay" onclick="closeModal('share-modal')"></div>
    <div class="share-modal-content">
        <div class="share-modal-header">
            <h3><i class="fas fa-share-alt"></i> Share Post</h3>
            <button class="share-modal-close" onclick="closeModal('share-modal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="share-modal-body">
            <!-- Link Sharing Section -->
            <div class="share-section">
                <h4><i class="fas fa-link"></i> Share Link</h4>
                <div class="share-link-container">
                    <input type="text" id="share-link-input" readonly placeholder="Loading...">
                    <button onclick="copyShareLink()" class="copy-btn" title="Copy Link">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <!-- Social Media Sharing -->
            <div class="share-section">
                <h4><i class="fas fa-share-nodes"></i> Share on Social Media</h4>
                <div class="social-share-grid">
                    <button class="social-share-btn reddit" onclick="shareToReddit()">
                        <i class="fab fa-reddit-alien"></i>
                        <span>Reddit</span>
                    </button>
                    <button class="social-share-btn twitter" onclick="shareToTwitter()">
                        <i class="fab fa-twitter"></i>
                        <span>Twitter</span>
                    </button>
                    <button class="social-share-btn telegram" onclick="shareToTelegram()">
                        <i class="fab fa-telegram"></i>
                        <span>Telegram</span>
                    </button>
                    <button class="social-share-btn whatsapp" onclick="shareToWhatsApp()">
                        <i class="fab fa-whatsapp"></i>
                        <span>WhatsApp</span>
                    </button>
                    <button class="social-share-btn facebook" onclick="shareToFacebook()">
                        <i class="fab fa-facebook"></i>
                        <span>Facebook</span>
                    </button>
                    <button class="social-share-btn discord" onclick="shareToDiscord()">
                        <i class="fab fa-discord"></i>
                        <span>Discord</span>
                    </button>
                </div>
            </div>
            
            <!-- Cross-post Section -->
            {{if .User}}
            <div class="share-section">
                <h4><i class="fas fa-arrows-alt"></i> Cross-post to Community</h4>
                <div class="crosspost-container">
                    <select id="crosspost-community" class="crosspost-select">
                        <option value="">Select a community...</option>
                        {{range .Communities}}
                        <option value="{{.Name}}">z/{{.DisplayName}}</option>
                        {{end}}
                    </select>
                    <button onclick="createCrossPost()" class="crosspost-btn">
                        <i class="fas fa-plus"></i>
                        Cross-post
                    </button>
                </div>
                <small class="crosspost-note">
                    <i class="fas fa-info-circle"></i>
                    Cross-posting will create a new post in the selected community that links back to this original post
                </small>
            </div>
            {{end}}
            
            <!-- QR Code Section -->
            <div class="share-section qr-section">
                <h4><i class="fas fa-qrcode"></i> QR Code</h4>
                <div id="qr-code" class="qr-code-container" onclick="generateQRCode('{{.Thread.ID}}')">
                    <div class="qr-placeholder-content">
                        <i class="fas fa-qrcode"></i>
                        <span>Tap to Generate</span>
                        <small>Click to generate QR code</small>
                    </div>
                </div>
                <button onclick="downloadQR()" class="btn btn-secondary btn-sm mt-2">
                    <i class="fas fa-download"></i> Download QR Code
                </button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/app.js"></script>
<script src="/static/js/show_threads.js"></script>

<link rel="stylesheet" href="/static/css/show_threads.css">
<link rel="icon" href="/static/images/cat_icon.png" type="image/x-icon">
{{end}}