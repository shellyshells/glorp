{{define "content"}}
<div class="thread-container">
    <div class="thread-card">
        <div class="thread-content-wrapper">
            <div class="thread-vote-section">
                {{if .User}}
                    <button class="vote-arrow {{if eq .Thread.UserVote 1}}upvoted{{end}}" onclick="voteThread('{{.Thread.ID}}', 1)" title="Upvote">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                {{else}}
                    <a href="/login" class="vote-arrow" title="Login to vote">
                        <i class="fas fa-arrow-up"></i>
                    </a>
                {{end}}
                
                <div class="vote-score" id="thread-score">{{.Thread.Score}}</div>
                
                {{if .User}}
                    <button class="vote-arrow {{if eq .Thread.UserVote -1}}downvoted{{end}}" onclick="voteThread('{{.Thread.ID}}', -1)" title="Downvote">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                {{else}}
                    <a href="/login" class="vote-arrow" title="Login to vote">
                        <i class="fas fa-arrow-down"></i>
                    </a>
                {{end}}
            </div>
            
            <div class="thread-main-content">
                <div class="thread-meta-line">
                    {{range .Thread.Tags}}
                        <a href="/?tag={{.Name}}" class="community-link">z/{{.Name}}</a>
                    {{end}}
                    <span>â€¢</span>
                    <span>Posted by 
                        <div class="inline-user-info">
                            <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Thread.Author)}}">
                                {{if .Thread.Author.AvatarURL}}
                                    <img src="{{.Thread.Author.AvatarURL}}" alt="{{.Thread.Author.Username}}" class="avatar-img">
                                {{else}}
                                    <span class="avatar-initial">{{getUserInitial .Thread.Author}}</span>
                                {{end}}
                                {{if isUserOnline .Thread.Author}}
                                    <div class="online-indicator"></div>
                                {{end}}
                            </div>
                            <a href="/user/{{.Thread.Author.Username}}" class="user-link">u/{{.Thread.Author.Username}}</a>
                        </div>
                    </span>
                    <span>â€¢</span>
                    <span title="{{.Thread.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .Thread.CreatedAt}}</span>
                    {{if eq .Thread.Status "closed"}}
                        <span class="status-badge">ðŸ”’ Closed</span>
                    {{end}}
                    {{if ne .Thread.PostType "text"}}
                        <span class="post-type-badge post-type-{{.Thread.PostType}}">
                            {{if eq .Thread.PostType "image"}}ðŸ“·{{else if eq .Thread.PostType "link"}}ðŸ”—{{end}}
                            {{upper .Thread.PostType}}
                        </span>
                    {{end}}
                </div>
                
                <h1 class="thread-title">{{.Thread.Title}}</h1>
                
                {{/* Display content based on post type */}}
                {{if eq .Thread.PostType "image"}}
                    {{if .Thread.ImageURL}}
                    <div class="thread-image-container">
                        <img src="{{.Thread.ImageURL}}" alt="{{.Thread.Title}}" class="thread-image" onclick="openImageModal(this.src)">
                    </div>
                    {{end}}
                    {{if .Thread.Description}}
                    <div class="thread-description">
                        <p>{{.Thread.Description}}</p>
                    </div>
                    {{end}}
                {{else if eq .Thread.PostType "link"}}
                    {{if .Thread.LinkURL}}
                    <div class="thread-link-container">
                        <div class="link-preview">
                            <div class="link-info">
                                <i class="fas fa-external-link-alt"></i>
                                <span class="link-domain">{{.Thread.LinkURL}}</span>
                            </div>
                            <a href="{{.Thread.LinkURL}}" target="_blank" rel="noopener noreferrer" class="link-button">
                                Visit Link <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    {{end}}
                    {{if .Thread.Description}}
                    <div class="thread-description">
                        <p>{{.Thread.Description}}</p>
                    </div>
                    {{end}}
                {{else}}
                    {{/* Text post */}}
                    {{if .Thread.Description}}
                    <div class="thread-description">
                        <p>{{.Thread.Description}}</p>
                    </div>
                    {{end}}
                {{end}}
                
                <div class="thread-footer">
                    <div class="thread-action">
                        <i class="fas fa-comment"></i>
                        <span>{{.Thread.MessageCount}} {{pluralize .Thread.MessageCount "comment" "comments"}}</span>
                    </div>
                    
                    <div class="thread-options-dropdown">
                        <div class="thread-action thread-dropdown-toggle" onclick="toggleThreadOptions(this, '{{.Thread.ID}}', {{.IsAuthor}}, {{.IsAdmin}})">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="thread-dropdown-menu">
                            <a href="#" class="dropdown-item" onclick="shareThread('{{.Thread.ID}}'); return false;">
                                <i class="fas fa-share"></i> Share
                            </a>
                            <a href="#" class="dropdown-item" onclick="saveThread('{{.Thread.ID}}'); return false;">
                                <i class="fas fa-bookmark"></i> Save
                            </a>
                            {{if or (eq .User.ID .Thread.AuthorID) (eq .User.Role "admin")}}
                            <hr class="dropdown-divider">
                            <a href="/threads/{{.Thread.ID}}/edit" class="dropdown-item">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            {{end}}
                            {{if eq .User.Role "admin"}}
                            <a href="#" class="dropdown-item dropdown-item-danger" onclick="deleteThread('{{.Thread.ID}}'); return false;">
                                <i class="fas fa-trash-alt"></i> Delete
                            </a>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="comments-section">
        <div class="comments-header">
            <div class="comments-sort">
                <label>Sort by:</label>
                <select id="sort-select" onchange="updateSort(this.value)">
                    <option value="date" {{if eq .SortBy "date"}}selected{{end}}>Best</option>
                    <option value="popularity" {{if eq .SortBy "popularity"}}selected{{end}}>Top</option>
                    <option value="new" {{if eq .SortBy "new"}}selected{{end}}>New</option>
                </select>
            </div>
        </div>

        {{if .User}}
            {{if ne .Thread.Status "closed"}}
            <div class="comment-form-container">
                <div class="comment-form-header">
                    <div class="comment-as-user">
                        <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .User)}}">
                            {{if .User.AvatarURL}}
                                <img src="{{.User.AvatarURL}}" alt="{{.User.Username}}" class="avatar-img">
                            {{else}}
                                <span class="avatar-initial">{{getUserInitial .User}}</span>
                            {{end}}
                        </div>
                        <span>Comment as <strong>u/{{.User.Username}}</strong></span>
                    </div>
                </div>
                <form id="comment-form" class="comment-form">
                    <div class="comment-input-area">
                        <textarea id="comment-content" name="content" placeholder="What are your thoughts?" required></textarea>
                    </div>
                    <div class="comment-form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-comment"></i> Comment
                        </button>
                    </div>
                    <div id="comment-error" class="error-message" style="display: none;"></div>
                </form>
            </div>
            {{else}}
                <div class="closed-notice">
                    <i class="fas fa-lock"></i> This thread is locked and no longer accepts new comments.
                </div>
            {{end}}
        {{else}}
            <div class="login-prompt">
                <p>Log in or sign up to leave a comment</p>
                <div class="auth-buttons">
                    <a href="/login" class="btn btn-outline">Log In</a>
                    <a href="/register" class="btn btn-primary">Sign Up</a>
                </div>
            </div>
        {{end}}

        <div class="comments-list" id="comments-list">
            {{if .Messages}}
                {{range .Messages}}
                <div class="comment-item" data-comment-id="{{.ID}}">
                    <div class="comment-vote-section">
                        {{if $.User}}
                            <button class="comment-vote-btn {{if eq .UserVote 1}}upvoted{{end}}" onclick="voteComment('{{.ID}}', 1)">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        {{else}}
                            <a href="/login" class="comment-vote-btn" title="Login to vote">
                                <i class="fas fa-arrow-up"></i>
                            </a>
                        {{end}}
                        
                        <span class="comment-score">{{.Score}}</span>
                        
                        {{if $.User}}
                            <button class="comment-vote-btn {{if eq .UserVote -1}}downvoted{{end}}" onclick="voteComment('{{.ID}}', -1)">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        {{else}}
                            <a href="/login" class="comment-vote-btn" title="Login to vote">
                                <i class="fas fa-arrow-down"></i>
                            </a>
                        {{end}}
                    </div>
                    
                    <div class="comment-content-section">
                        <div class="comment-header">
                            <div class="comment-author-info">
                                <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Author)}}">
                                    {{if .Author.AvatarURL}}
                                        <img src="{{.Author.AvatarURL}}" alt="{{.Author.Username}}" class="avatar-img">
                                    {{else}}
                                        <span class="avatar-initial">{{getUserInitial .Author}}</span>
                                    {{end}}
                                    {{if isUserOnline .Author}}
                                        <div class="online-indicator"></div>
                                    {{end}}
                                </div>
                                <a href="/user/{{.Author.Username}}" class="comment-author">u/{{.Author.Username}}</a>
                            </div>
                            <span class="comment-score-inline">{{.Score}} points</span>
                            <span class="comment-time" title="{{.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .CreatedAt}}</span>
                        </div>
                        
                        <div class="comment-content">
                            <p>{{.Content}}</p>
                        </div>
                        
                        <div class="comment-actions">
                            {{if $.User}}
                                <button class="comment-action-btn" onclick="toggleReplyForm('{{.ID}}')">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                            {{end}}
                            
                            <button class="comment-action-btn" onclick="shareComment('{{.ID}}')">
                                <i class="fas fa-share"></i> Share
                            </button>
                            
                            {{if and (.Replies) (gt (len .Replies) 0)}}
                                <button class="comment-action-btn toggle-replies-btn" onclick="toggleReplies('{{.ID}}')" data-expanded="true">
                                    <i class="fas fa-chevron-up"></i>
                                    <span class="toggle-text">Hide {{len .Replies}} {{if eq (len .Replies) 1}}reply{{else}}replies{{end}}</span>
                                </button>
                            {{end}}
                            
                            {{if $.User}}
                                {{if or (eq $.User.ID .AuthorID) (eq $.User.Role "admin")}}
                                <button class="comment-action-btn danger" onclick="deleteComment('{{.ID}}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                {{end}}
                            {{end}}
                        </div>
                        
                        <!-- Reply form (hidden by default) -->
                        {{if $.User}}
                        <div class="reply-form" id="reply-form-{{.ID}}" style="display: none;">
                            <div class="reply-form-header">
                                <div class="reply-as-user">
                                    <div class="user-avatar-small {{getAvatarClass (getAvatarStyle $.User)}}">
                                        {{if $.User.AvatarURL}}
                                            <img src="{{$.User.AvatarURL}}" alt="{{$.User.Username}}" class="avatar-img">
                                        {{else}}
                                            <span class="avatar-initial">{{getUserInitial $.User}}</span>
                                        {{end}}
                                    </div>
                                    <span>Reply as <strong>u/{{$.User.Username}}</strong></span>
                                </div>
                            </div>
                            <form onsubmit="submitReply(event, '{{.ID}}')">
                                <textarea placeholder="What are your thoughts?" required></textarea>
                                <div class="reply-form-actions">
                                    <button type="button" onclick="cancelReply('{{.ID}}')" class="btn btn-outline btn-sm">Cancel</button>
                                    <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                                </div>
                            </form>
                        </div>
                        {{end}}

                        <!-- Nested Replies -->
                        {{if .Replies}}
                        <div class="nested-replies" id="replies-{{.ID}}">
                            {{range .Replies}}
                            <div class="comment-item nested-comment" data-comment-id="{{.ID}}" data-level="{{.Level}}">
                                <div class="comment-vote-section">
                                    {{if $.User}}
                                        <button class="comment-vote-btn {{if eq .UserVote 1}}upvoted{{end}}" onclick="voteComment('{{.ID}}', 1)">
                                            <i class="fas fa-arrow-up"></i>
                                        </button>
                                    {{else}}
                                        <a href="/login" class="comment-vote-btn" title="Login to vote">
                                            <i class="fas fa-arrow-up"></i>
                                        </a>
                                    {{end}}
                                    
                                    <span class="comment-score">{{.Score}}</span>
                                    
                                    {{if $.User}}
                                        <button class="comment-vote-btn {{if eq .UserVote -1}}downvoted{{end}}" onclick="voteComment('{{.ID}}', -1)">
                                            <i class="fas fa-arrow-down"></i>
                                        </button>
                                    {{else}}
                                        <a href="/login" class="comment-vote-btn" title="Login to vote">
                                            <i class="fas fa-arrow-down"></i>
                                        </a>
                                    {{end}}
                                </div>
                                
                                <div class="comment-content-section">
                                    <div class="comment-header">
                                        <div class="comment-author-info">
                                            <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Author)}}">
                                                {{if .Author.AvatarURL}}
                                                    <img src="{{.Author.AvatarURL}}" alt="{{.Author.Username}}" class="avatar-img">
                                                {{else}}
                                                    <span class="avatar-initial">{{getUserInitial .Author}}</span>
                                                {{end}}
                                                {{if isUserOnline .Author}}
                                                    <div class="online-indicator"></div>
                                                {{end}}
                                            </div>
                                            <a href="/user/{{.Author.Username}}" class="comment-author">u/{{.Author.Username}}</a>
                                        </div>
                                        <span class="comment-score-inline">{{.Score}} points</span>
                                        <span class="comment-time" title="{{.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .CreatedAt}}</span>
                                        <span class="comment-reply-indicator">
                                            <i class="fas fa-reply"></i> reply
                                        </span>
                                    </div>
                                    
                                    <div class="comment-content">
                                        <p>{{.Content}}</p>
                                    </div>
                                    
                                    <div class="comment-actions">
                                        {{if $.User}}
                                            <button class="comment-action-btn" onclick="toggleReplyForm('{{.ID}}')">
                                                <i class="fas fa-reply"></i> Reply
                                            </button>
                                        {{end}}
                                        
                                        <button class="comment-action-btn" onclick="shareComment('{{.ID}}')">
                                            <i class="fas fa-share"></i> Share
                                        </button>
                                        
                                        {{if and (.Replies) (gt (len .Replies) 0)}}
                                            <button class="comment-action-btn toggle-replies-btn" onclick="toggleReplies('{{.ID}}')" data-expanded="true">
                                                <i class="fas fa-chevron-up"></i>
                                                <span class="toggle-text">Hide {{len .Replies}} {{if eq (len .Replies) 1}}reply{{else}}replies{{end}}</span>
                                            </button>
                                        {{end}}
                                        
                                        {{if $.User}}
                                            {{if or (eq $.User.ID .AuthorID) (eq $.User.Role "admin")}}
                                            <button class="comment-action-btn danger" onclick="deleteComment('{{.ID}}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                            {{end}}
                                        {{end}}
                                    </div>
                                    
                                    <!-- Reply form for nested comment -->
                                    {{if $.User}}
                                    <div class="reply-form" id="reply-form-{{.ID}}" style="display: none;">
                                        <div class="reply-form-header">
                                            <div class="reply-as-user">
                                                <div class="user-avatar-small {{getAvatarClass (getAvatarStyle $.User)}}">
                                                    {{if $.User.AvatarURL}}
                                                        <img src="{{$.User.AvatarURL}}" alt="{{$.User.Username}}" class="avatar-img">
                                                    {{else}}
                                                        <span class="avatar-initial">{{getUserInitial $.User}}</span>
                                                    {{end}}
                                                </div>
                                                <span>Reply as <strong>u/{{$.User.Username}}</strong></span>
                                            </div>
                                        </div>
                                        <form onsubmit="submitReply(event, '{{.ID}}')">
                                            <textarea placeholder="What are your thoughts?" required></textarea>
                                            <div class="reply-form-actions">
                                                <button type="button" onclick="cancelReply('{{.ID}}')" class="btn btn-outline btn-sm">Cancel</button>
                                                <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                                            </div>
                                        </form>
                                    </div>
                                    {{end}}
                                    
                                    <!-- Nested replies for this reply -->
                                    {{if .Replies}}
                                    <div class="nested-replies" id="replies-{{.ID}}">
                                        {{range .Replies}}
                                        <div class="comment-item nested-comment" data-comment-id="{{.ID}}" data-level="{{.Level}}">
                                            <!-- Same structure as above, but with increased indentation -->
                                            <div class="comment-vote-section">
                                                {{if $.User}}
                                                    <button class="comment-vote-btn {{if eq .UserVote 1}}upvoted{{end}}" onclick="voteComment('{{.ID}}', 1)">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                {{else}}
                                                    <a href="/login" class="comment-vote-btn" title="Login to vote">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </a>
                                                {{end}}
                                                
                                                <span class="comment-score">{{.Score}}</span>
                                                
                                                {{if $.User}}
                                                    <button class="comment-vote-btn {{if eq .UserVote -1}}downvoted{{end}}" onclick="voteComment('{{.ID}}', -1)">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </button>
                                                {{else}}
                                                    <a href="/login" class="comment-vote-btn" title="Login to vote">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </a>
                                                {{end}}
                                            </div>
                                            
                                            <div class="comment-content-section">
                                                <div class="comment-header">
                                                    <div class="comment-author-info">
                                                        <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Author)}}">
                                                            {{if .Author.AvatarURL}}
                                                                <img src="{{.Author.AvatarURL}}" alt="{{.Author.Username}}" class="avatar-img">
                                                            {{else}}
                                                                <span class="avatar-initial">{{getUserInitial .Author}}</span>
                                                            {{end}}
                                                            {{if isUserOnline .Author}}
                                                                <div class="online-indicator"></div>
                                                            {{end}}
                                                        </div>
                                                        <a href="/user/{{.Author.Username}}" class="comment-author">u/{{.Author.Username}}</a>
                                                    </div>
                                                    <span class="comment-score-inline">{{.Score}} points</span>
                                                    <span class="comment-time" title="{{.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .CreatedAt}}</span>
                                                </div>
                                                
                                                <div class="comment-content">
                                                    <p>{{.Content}}</p>
                                                </div>
                                                
                                                <div class="comment-actions">
                                                    {{if $.User}}
                                                        <button class="comment-action-btn" onclick="toggleReplyForm('{{.ID}}')">
                                                            <i class="fas fa-reply"></i> Reply
                                                        </button>
                                                    {{end}}
                                                    
                                                    <button class="comment-action-btn" onclick="shareComment('{{.ID}}')">
                                                        <i class="fas fa-share"></i> Share
                                                    </button>
                                                    
                                                    {{if $.User}}
                                                        {{if or (eq $.User.ID .AuthorID) (eq $.User.Role "admin")}}
                                                        <button class="comment-action-btn danger" onclick="deleteComment('{{.ID}}')">
                                                            <i class="fas fa-trash"></i> Delete
                                                        </button>
                                                        {{end}}
                                                    {{end}}
                                                </div>
                                                
                                                <!-- Reply form for deepest level -->
                                                {{if $.User}}
                                                <div class="reply-form" id="reply-form-{{.ID}}" style="display: none;">
                                                    <div class="reply-form-header">
                                                        <div class="reply-as-user">
                                                            <div class="user-avatar-small {{getAvatarClass (getAvatarStyle $.User)}}">
                                                                {{if $.User.AvatarURL}}
                                                                    <img src="{{$.User.AvatarURL}}" alt="{{$.User.Username}}" class="avatar-img">
                                                                {{else}}
                                                                    <span class="avatar-initial">{{getUserInitial $.User}}</span>
                                                                {{end}}
                                                            </div>
                                                            <span>Reply as <strong>u/{{$.User.Username}}</strong></span>
                                                        </div>
                                                    </div>
                                                    <form onsubmit="submitReply(event, '{{.ID}}')">
                                                        <textarea placeholder="What are your thoughts?" required></textarea>
                                                        <div class="reply-form-actions">
                                                            <button type="button" onclick="cancelReply('{{.ID}}')" class="btn btn-outline btn-sm">Cancel</button>
                                                            <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                                                        </div>
                                                    </form>
                                                </div>
                                                {{end}}
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                </div>
                            </div>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}
            {{else}}
                <div class="empty-comments">
                    <i class="fas fa-comment-slash"></i>
                    <h3>No comments yet</h3>
                    <p>Be the first to share what you think!</p>
                </div>
            {{end}}
        </div>

        {{if gt .Pagination.TotalPages 1}}
        <div class="pagination">
            {{if .Pagination.HasPrev}}
                <a href="?page={{sub .Pagination.CurrentPage 1}}{{if .SortBy}}&sort={{.SortBy}}{{end}}" class="pagination-btn">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            {{end}}
            
            <span class="pagination-info">
                Page {{.Pagination.CurrentPage}} of {{.Pagination.TotalPages}}
            </span>
            
            {{if .Pagination.HasNext}}
                <a href="?page={{add .Pagination.CurrentPage 1}}{{if .SortBy}}&sort={{.SortBy}}{{end}}" class="pagination-btn">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            {{end}}
        </div>
        {{end}}
    </div>
</div>

<!-- Image Modal -->
<div id="image-modal" class="image-modal" style="display: none;" onclick="closeImageModal()">
    <div class="image-modal-content">
        <img id="modal-image" src="" alt="">
        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Share</h3>
            <button class="modal-close" onclick="closeModal('share-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="share-link">
                <input type="text" id="share-link-input" readonly>
                <button onclick="copyShareLink()">Copy</button>
            </div>
        </div>
    </div>
</div>

<script>
// Image modal functions
function openImageModal(imageSrc) {
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    modalImage.src = imageSrc;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    const modal = document.getElementById('image-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close image modal with escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// Post comment functionality
document.getElementById('comment-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const content = formData.get('content');
    const errorDiv = document.getElementById('comment-error');
    const submitBtn = this.querySelector('button[type="submit"]');
    
    if (!content.trim()) {
        errorDiv.textContent = 'Comment cannot be empty';
        errorDiv.style.display = 'block';
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Posting...';
    
    try {
        const response = await fetch(`/api/threads/{{.Thread.ID}}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const result = await response.text();
            errorDiv.textContent = result;
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = 'Failed to post comment. Please try again.';
        errorDiv.style.display = 'block';
        console.error('Error posting comment:', error);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-comment"></i> Comment';
    }
});

// Vote comment functionality
async function voteComment(commentId, voteType) {
    try {
        const response = await fetch(`/api/messages/${commentId}/vote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ vote_type: voteType })
        });
        
        if (response.ok) {
            const result = await response.json();
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (!commentElement) return;
            
            const scoreElements = commentElement.querySelectorAll('.comment-score');
            const voteButtons = commentElement.querySelectorAll('.comment-vote-btn');
            
            scoreElements.forEach(el => el.textContent = result.score);
            const scoreInline = commentElement.querySelector('.comment-score-inline');
            if (scoreInline) {
                scoreInline.textContent = `${result.score} points`;
            }
            
            const upvoteBtn = voteButtons[0];
            const downvoteBtn = voteButtons[1];
            
            if (upvoteBtn && downvoteBtn) {
                upvoteBtn.classList.toggle('upvoted', result.user_vote === 1);
                downvoteBtn.classList.toggle('downvoted', result.user_vote === -1);
            }
            
            if (window.Glorp) {
                const action = result.user_vote === voteType ? 
                    (voteType === 1 ? 'upvoted' : 'downvoted') : 'removed vote';
                Glorp.showNotification(`Comment ${action}!`, 'success');
            }
        } else {
            const result = await response.text();
            if (window.Glorp) {
                Glorp.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error voting:', error);
        if (window.Glorp) {
            Glorp.showNotification('Failed to vote. Please try again.', 'error');
        }
    }
}

// Vote thread functionality
async function voteThread(threadId, voteType) {
    try {
        const response = await fetch(`/api/threads/${threadId}/vote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ vote_type: voteType })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Update the vote display
            const scoreElement = document.getElementById('thread-score');
            const upvoteBtn = document.querySelector('.thread-vote-section .vote-arrow:first-child');
            const downvoteBtn = document.querySelector('.thread-vote-section .vote-arrow:last-child');
            
            if (scoreElement && upvoteBtn && downvoteBtn) {
                // Update score
                scoreElement.textContent = result.score;
                scoreElement.dataset.score = result.score;
                
                // Update button states
                upvoteBtn.classList.toggle('upvoted', result.user_vote === 1);
                downvoteBtn.classList.toggle('downvoted', result.user_vote === -1);
            }
            
            if (window.Glorp) {
                const action = result.user_vote === voteType ? 
                    (voteType === 1 ? 'upvoted' : 'downvoted') : 'removed vote';
                Glorp.showNotification(`Post ${action}!`, 'success');
            }
        } else {
            const result = await response.text();
            if (window.Glorp) {
                Glorp.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error voting on thread:', error);
        if (window.Glorp) {
            Glorp.showNotification('Failed to vote. Please try again.', 'error');
        }
    }
}

// Delete comment functionality
async function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/messages/${commentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload(); // Refresh to remove deleted comment
        } else {
            const result = await response.text();
            if (window.Glorp) {
                Glorp.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error deleting comment:', error);
        if (window.Glorp) {
            Glorp.showNotification('Failed to delete comment. Please try again.', 'error');
        }
    }
}

// Delete thread functionality
async function deleteThread(threadId) {
    if (!confirm('Are you sure you want to delete this thread? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/threads/${threadId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            if (window.Glorp) {
                Glorp.showNotification('Thread deleted successfully', 'success');
            }
            setTimeout(() => {
                window.location.href = '/'; // Redirect to home
            }, 1000);
        } else {
            const result = await response.text();
            if (window.Glorp) {
                Glorp.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error deleting thread:', error);
        if (window.Glorp) {
            Glorp.showNotification('Failed to delete thread. Please try again.', 'error');
        }
    }
}

// Toggle reply form
function toggleReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    const isVisible = replyForm.style.display !== 'none';
    
    // Hide all other reply forms first
    document.querySelectorAll('.reply-form').forEach(form => {
        form.style.display = 'none';
    });
    
    if (!isVisible) {
        replyForm.style.display = 'block';
        replyForm.querySelector('textarea').focus();
    }
}

function cancelReply(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = 'none';
    replyForm.querySelector('textarea').value = '';
}

// Submit nested reply
async function submitReply(event, parentCommentId) {
    event.preventDefault();
    
    const form = event.target;
    const textarea = form.querySelector('textarea');
    const content = textarea.value.trim();
    
    if (!content) {
        if (window.Glorp) {
            Glorp.showNotification('Reply cannot be empty', 'error');
        }
        return;
    }
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Posting...';
    
    try {
        const response = await fetch(`/api/threads/{{.Thread.ID}}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                content: content,
                parent_id: parseInt(parentCommentId)
            })
        });
        
        if (response.ok) {
            // Reload page to show new reply
            location.reload();
        } else {
            const result = await response.text();
            if (window.Glorp) {
                Glorp.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error posting reply:', error);
        if (window.Glorp) {
            Glorp.showNotification('Failed to post reply. Please try again.', 'error');
        }
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Toggle replies visibility
function toggleReplies(commentId) {
    const repliesContainer = document.getElementById(`replies-${commentId}`);
    const toggleBtn = document.querySelector(`[onclick="toggleReplies('${commentId}')"]`);
    
    if (!repliesContainer || !toggleBtn) return;
    
    const toggleText = toggleBtn.querySelector('.toggle-text');
    const toggleIcon = toggleBtn.querySelector('i');
    const isExpanded = toggleBtn.dataset.expanded === 'true';
    
    if (isExpanded) {
        // Collapse replies
        repliesContainer.style.display = 'none';
        toggleBtn.dataset.expanded = 'false';
        const replyCount = repliesContainer.children.length;
        toggleText.textContent = `Show ${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}`;
        toggleIcon.className = 'fas fa-chevron-down';
    } else {
        // Expand replies
        repliesContainer.style.display = 'block';
        toggleBtn.dataset.expanded = 'true';
        const replyCount = repliesContainer.children.length;
        toggleText.textContent = `Hide ${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}`;
        toggleIcon.className = 'fas fa-chevron-up';
    }
}

// Share functionality
function shareThread(threadId) {
    const shareUrl = `${window.location.origin}/threads/${threadId}`;
    document.getElementById('share-link-input').value = shareUrl;
    document.getElementById('share-modal').style.display = 'flex';
}

function shareComment(commentId) {
    const shareUrl = `${window.location.href}#comment-${commentId}`;
    document.getElementById('share-link-input').value = shareUrl;
    document.getElementById('share-modal').style.display = 'flex';
}

function copyShareLink() {
    const input = document.getElementById('share-link-input');
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    if (window.Glorp) {
        Glorp.showNotification('Link copied to clipboard!', 'success');
    }
    closeModal('share-modal');
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Save functionality
function saveThread(threadId) {
    if (window.Glorp) {
        Glorp.showNotification('Save feature coming soon!', 'info');
    }
}

// Sort functionality
function updateSort(sortBy) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

// Auto-resize textarea
const textarea = document.querySelector('#comment-content');
if (textarea) {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.max(80, this.scrollHeight) + 'px';
    });
}

// Helper functions for template
function sub(a, b) { return a - b; }
function add(a, b) { return a + b; }

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('share-modal');
    if (e.target === modal) {
        closeModal('share-modal');
    }
});
</script>

<style>
/* Enhanced comment styles */
.comment-item {
    display: flex;
    gap: 12px;
    background: white;
    padding: 16px 20px;
    border-bottom: 1px solid #edeff1;
    position: relative;
}

.nested-comment {
    margin-left: 20px;
    border-left: 2px solid #0079d3;
    padding-left: 12px;
    background: #fafafa;
}

.nested-comment .nested-comment {
    margin-left: 16px;
    background: #f5f5f5;
}

.nested-comment .nested-comment .nested-comment {
    margin-left: 12px;
    background: #f0f0f0;
}

.comment-vote-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    min-width: 32px;
}

.comment-vote-btn {
    width: 24px;
    height: 24px;
    border: none;
    background: none;
    cursor: pointer;
    color: #878a8c;
    transition: all 0.2s;
    border-radius: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
}

.comment-vote-btn:hover {
    background: #f6f7f8;
    color: #1a1a1b;
}

.comment-vote-btn.upvoted {
    color: #ff4500;
    background: rgba(255, 69, 0, 0.1);
}

.comment-vote-btn.downvoted {
    color: #7193ff;
    background: rgba(113, 147, 255, 0.1);
}

.comment-score {
    font-size: 12px;
    font-weight: 700;
    color: #878a8c;
}

.comment-content-section {
    flex: 1;
}

.comment-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 12px;
    color: #878a8c;
    flex-wrap: wrap;
}

.comment-author-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.comment-author {
    font-weight: 700;
    color: #0079d3;
    text-decoration: none;
}

.comment-author:hover {
    text-decoration: underline;
}

.comment-reply-indicator {
    color: #878a8c;
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.comment-content {
    margin-bottom: 12px;
}

.comment-content p {
    margin: 0;
    color: #1a1a1b;
    line-height: 1.5;
    word-wrap: break-word;
}

.comment-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
    margin-bottom: 8px;
}

.comment-action-btn {
    background: none;
    border: none;
    color: #878a8c;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 2px;
    transition: all 0.2s;
    font-size: 12px;
    font-weight: 600;
}

.comment-action-btn:hover {
    background: #f6f7f8;
    color: #1a1a1b;
}

.comment-action-btn.danger:hover {
    background: #ffebee;
    color: #d32f2f;
}

.toggle-replies-btn {
    font-weight: 700;
}

.reply-form {
    margin-top: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #edeff1;
}

.reply-form-header {
    margin-bottom: 8px;
}

.reply-as-user {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #878a8c;
}

.reply-form textarea {
    width: 100%;
    min-height: 60px;
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: vertical;
    font-family: inherit;
    font-size: 14px;
    margin-bottom: 8px;
}

.reply-form textarea:focus {
    outline: none;
    border-color: #0079d3;
    box-shadow: 0 0 0 2px rgba(0,121,211,0.2);
}

.reply-form-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.nested-replies {
    margin-top: 8px;
}

.nested-replies .nested-replies {
    margin-top: 4px;
}

.nested-replies .nested-replies .nested-replies {
    margin-top: 2px;
}

/* Responsive design */
@media (max-width: 768px) {
    .nested-comment {
        margin-left: 12px;
        padding-left: 8px;
    }
    
    .comment-vote-section {
        flex-direction: row;
        justify-content: center;
        min-width: unset;
        padding: 8px;
        margin-bottom: 8px;
    }
    
    .comment-score {
        margin: 0 8px;
    }
}

/* Thread vote section styles */
.thread-vote-section .vote-arrow.upvoted {
    color: #ff4500;
    background: rgba(255, 69, 0, 0.1);
}

.thread-vote-section .vote-arrow.downvoted {
    color: #7193ff;
    background: rgba(113, 147, 255, 0.1);
}

/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.thread-image-container {
    margin: 16px 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #edeff1;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    max-height: 400px; /* Slightly larger for individual thread view */
}

.thread-image {
    max-width: 100%;
    max-height: 400px;
    width: auto;
    height: auto;
    object-fit: contain;
    cursor: zoom-in;
    transition: all 0.2s ease;
}

.thread-image:hover {
    transform: scale(1.02);
}
</style>
{{end}}