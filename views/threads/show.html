{{define "content"}}
<div class="thread-container">
    <div class="thread-card">
        <div class="thread-content-wrapper">
            <div class="thread-vote-section">
                {{if .User}}
                    <button class="vote-arrow" onclick="voteThread('{{.Thread.ID}}', 1)" title="Upvote">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                {{else}}
                    <a href="/login" class="vote-arrow" title="Login to vote">
                        <i class="fas fa-arrow-up"></i>
                    </a>
                {{end}}
                
                <div class="vote-score" id="thread-score">{{.Thread.MessageCount}}</div>
                
                {{if .User}}
                    <button class="vote-arrow" onclick="voteThread('{{.Thread.ID}}', -1)" title="Downvote">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                {{else}}
                    <a href="/login" class="vote-arrow" title="Login to vote">
                        <i class="fas fa-arrow-down"></i>
                    </a>
                {{end}}
            </div>
            
            <div class="thread-main-content">
                <div class="thread-meta-line">
                    {{range .Thread.Tags}}
                        <a href="/?tag={{.Name}}" class="community-link">r/{{.Name}}</a>
                    {{end}}
                    <span>â€¢</span>
                    <span>Posted by <a href="/user/{{.Thread.Author.Username}}" class="user-link">u/{{.Thread.Author.Username}}</a></span>
                    <span>â€¢</span>
                    <span title="{{.Thread.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .Thread.CreatedAt}}</span>
                    {{if eq .Thread.Status "closed"}}
                        <span class="status-badge">ðŸ”’ Closed</span>
                    {{end}}
                </div>
                
                <h1 class="thread-title">{{.Thread.Title}}</h1>
                
                {{if .Thread.Description}}
                <div class="thread-description">
                    <p>{{.Thread.Description}}</p>
                </div>
                {{end}}
                
                <div class="thread-footer">
                    <div class="thread-action">
                        <i class="fas fa-comment"></i>
                        <span>{{.Thread.MessageCount}} {{pluralize .Thread.MessageCount "comment" "comments"}}</span>
                    </div>
                    
                    <div class="thread-action" onclick="shareThread('{{.Thread.ID}}')">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </div>
                    
                    <div class="thread-action" onclick="saveThread('{{.Thread.ID}}')">
                        <i class="fas fa-bookmark"></i>
                        <span>Save</span>
                    </div>
                    
                    {{if .User}}
                        {{if or (eq .User.ID .Thread.AuthorID) (eq .User.Role "admin")}}
                        <div class="thread-action">
                            <a href="/threads/{{.Thread.ID}}/edit" style="color: inherit; text-decoration: none;">
                                <i class="fas fa-edit"></i>
                                <span>Edit</span>
                            </a>
                        </div>
                        <div class="thread-action" onclick="deleteThread('{{.Thread.ID}}')">
                            <i class="fas fa-trash"></i>
                            <span>Delete</span>
                        </div>
                        {{end}}
                    {{end}}
                </div>
            </div>
        </div>
    </div>

    <div class="comments-section">
        <div class="comments-header">
            <div class="comments-sort">
                <label>Sort by:</label>
                <select id="sort-select" onchange="updateSort(this.value)">
                    <option value="date" {{if eq .SortBy "date"}}selected{{end}}>Best</option>
                    <option value="popularity" {{if eq .SortBy "popularity"}}selected{{end}}>Top</option>
                    <option value="new" {{if eq .SortBy "new"}}selected{{end}}>New</option>
                </select>
            </div>
        </div>

        {{if .User}}
            {{if ne .Thread.Status "closed"}}
            <div class="comment-form-container">
                <div class="comment-form-header">
                    <span>Comment as <strong>u/{{.User.Username}}</strong></span>
                </div>
                <form id="comment-form" class="comment-form">
                    <div class="comment-input-area">
                        <textarea id="comment-content" name="content" placeholder="What are your thoughts?" required></textarea>
                    </div>
                    <div class="comment-form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-comment"></i> Comment
                        </button>
                    </div>
                    <div id="comment-error" class="error-message" style="display: none;"></div>
                </form>
            </div>
            {{else}}
                <div class="closed-notice">
                    <i class="fas fa-lock"></i> This thread is locked and no longer accepts new comments.
                </div>
            {{end}}
        {{else}}
            <div class="login-prompt">
                <p>Log in or sign up to leave a comment</p>
                <div class="auth-buttons">
                    <a href="/login" class="btn btn-outline">Log In</a>
                    <a href="/register" class="btn btn-primary">Sign Up</a>
                </div>
            </div>
        {{end}}

        <div class="comments-list" id="comments-list">
            {{if .Messages}}
                {{range .Messages}}
                <div class="comment-item" data-comment-id="{{.ID}}">
                    <div class="comment-vote-section">
                        {{if $.User}}
                            <button class="comment-vote-btn {{if eq .UserVote 1}}active{{end}}" onclick="voteComment('{{.ID}}', 1)">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        {{else}}
                            <a href="/login" class="comment-vote-btn" title="Login to vote">
                                <i class="fas fa-arrow-up"></i>
                            </a>
                        {{end}}
                        
                        <span class="comment-score">{{.Score}}</span>
                        
                        {{if $.User}}
                            <button class="comment-vote-btn {{if eq .UserVote -1}}active{{end}}" onclick="voteComment('{{.ID}}', -1)">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        {{else}}
                            <a href="/login" class="comment-vote-btn" title="Login to vote">
                                <i class="fas fa-arrow-down"></i>
                            </a>
                        {{end}}
                    </div>
                    
                    <div class="comment-content-section">
                        <div class="comment-header">
                            <a href="/user/{{.Author.Username}}" class="comment-author">u/{{.Author.Username}}</a>
                            <span class="comment-score-inline">{{.Score}} points</span>
                            <span class="comment-time" title="{{.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .CreatedAt}}</span>
                        </div>
                        
                        <div class="comment-content">
                            <p>{{.Content}}</p>
                        </div>
                        
                        <div class="comment-actions">
                            {{if $.User}}
                                <button class="comment-action-btn" onclick="replyToComment('{{.ID}}')">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                            {{end}}
                            
                            <button class="comment-action-btn" onclick="shareComment('{{.ID}}')">
                                <i class="fas fa-share"></i> Share
                            </button>
                            
                            {{if $.User}}
                                {{if or (eq $.User.ID .AuthorID) (eq $.User.Role "admin")}}
                                <button class="comment-action-btn danger" onclick="deleteComment('{{.ID}}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                {{end}}
                            {{end}}
                        </div>
                        
                        <!-- Reply form (hidden by default) -->
                        <div class="reply-form" id="reply-form-{{.ID}}" style="display: none;">
                            <form onsubmit="submitReply(event, '{{.ID}}')">
                                <textarea placeholder="What are your thoughts?" required></textarea>
                                <div class="reply-form-actions">
                                    <button type="button" onclick="cancelReply('{{.ID}}')" class="btn btn-outline btn-sm">Cancel</button>
                                    <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {{end}}
            {{else}}
                <div class="empty-comments">
                    <i class="fas fa-comment-slash"></i>
                    <h3>No comments yet</h3>
                    <p>Be the first to share what you think!</p>
                </div>
            {{end}}
        </div>

        {{if gt .Pagination.TotalPages 1}}
        <div class="pagination">
            {{if .Pagination.HasPrev}}
                <a href="?page={{sub .Pagination.CurrentPage 1}}{{if .SortBy}}&sort={{.SortBy}}{{end}}" class="pagination-btn">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            {{end}}
            
            <span class="pagination-info">
                Page {{.Pagination.CurrentPage}} of {{.Pagination.TotalPages}}
            </span>
            
            {{if .Pagination.HasNext}}
                <a href="?page={{add .Pagination.CurrentPage 1}}{{if .SortBy}}&sort={{.SortBy}}{{end}}" class="pagination-btn">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            {{end}}
        </div>
        {{end}}
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Share</h3>
            <button class="modal-close" onclick="closeModal('share-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="share-link">
                <input type="text" id="share-link-input" readonly>
                <button onclick="copyShareLink()">Copy</button>
            </div>
        </div>
    </div>
</div>

<script>
// Post comment functionality
document.getElementById('comment-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const content = formData.get('content');
    const errorDiv = document.getElementById('comment-error');
    const submitBtn = this.querySelector('button[type="submit"]');
    
    if (!content.trim()) {
        errorDiv.textContent = 'Comment cannot be empty';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Posting...';
    
    try {
        const response = await fetch(`/api/threads/{{.Thread.ID}}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content })
        });
        
        if (response.ok) {
            location.reload(); // Refresh to show new comment
        } else {
            const result = await response.text();
            errorDiv.textContent = result;
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = 'Failed to post comment. Please try again.';
        errorDiv.style.display = 'block';
        console.error('Error posting comment:', error);
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-comment"></i> Comment';
    }
});

// Vote comment functionality
async function voteComment(commentId, voteType) {
    try {
        const response = await fetch(`/api/messages/${commentId}/vote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ vote_type: voteType })
        });
        
        if (response.ok) {
            const result = await response.json();
            // Update vote counts in the UI
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            const scoreElements = commentElement.querySelectorAll('.comment-score');
            const voteButtons = commentElement.querySelectorAll('.comment-vote-btn');
            
            // Update scores
            scoreElements.forEach(el => el.textContent = result.score);
            commentElement.querySelector('.comment-score-inline').textContent = `${result.score} points`;
            
            // Update active states
            const upvoteBtn = voteButtons[0];
            const downvoteBtn = voteButtons[1];
            
            upvoteBtn.classList.toggle('active', result.user_vote === 1);
            downvoteBtn.classList.toggle('active', result.user_vote === -1);
            
            if (window.GoForum) {
                GoForum.showNotification('Vote recorded!', 'success');
            }
        } else {
            const result = await response.text();
            if (window.GoForum) {
                GoForum.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error voting:', error);
        if (window.GoForum) {
            GoForum.showNotification('Failed to vote. Please try again.', 'error');
        }
    }
}

// Vote thread functionality (placeholder)
async function voteThread(threadId, voteType) {
    // This would be implemented when you add thread voting
    if (window.GoForum) {
        GoForum.showNotification('Thread voting coming soon!', 'info');
    }
}

// Delete comment functionality
async function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/messages/${commentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload(); // Refresh to remove deleted comment
        } else {
            const result = await response.text();
            if (window.GoForum) {
                GoForum.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error deleting comment:', error);
        if (window.GoForum) {
            GoForum.showNotification('Failed to delete comment. Please try again.', 'error');
        }
    }
}

// Delete thread functionality
async function deleteThread(threadId) {
    if (!confirm('Are you sure you want to delete this thread? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/threads/${threadId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            if (window.GoForum) {
                GoForum.showNotification('Thread deleted successfully', 'success');
            }
            setTimeout(() => {
                window.location.href = '/'; // Redirect to home
            }, 1000);
        } else {
            const result = await response.text();
            if (window.GoForum) {
                GoForum.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error deleting thread:', error);
        if (window.GoForum) {
            GoForum.showNotification('Failed to delete thread. Please try again.', 'error');
        }
    }
}

// Reply functionality
function replyToComment(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
    
    if (replyForm.style.display === 'block') {
        replyForm.querySelector('textarea').focus();
    }
}

function cancelReply(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = 'none';
    replyForm.querySelector('textarea').value = '';
}

function submitReply(event, parentCommentId) {
    event.preventDefault();
    // This would be implemented when you add nested comments
    if (window.GoForum) {
        GoForum.showNotification('Nested replies coming soon!', 'info');
    }
}

// Share functionality
function shareThread(threadId) {
    const shareUrl = `${window.location.origin}/threads/${threadId}`;
    document.getElementById('share-link-input').value = shareUrl;
    document.getElementById('share-modal').style.display = 'flex';
}

function shareComment(commentId) {
    const shareUrl = `${window.location.href}#comment-${commentId}`;
    document.getElementById('share-link-input').value = shareUrl;
    document.getElementById('share-modal').style.display = 'flex';
}

function copyShareLink() {
    const input = document.getElementById('share-link-input');
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    if (window.GoForum) {
        GoForum.showNotification('Link copied to clipboard!', 'success');
    }
    closeModal('share-modal');
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Save functionality
function saveThread(threadId) {
    if (window.GoForum) {
        GoForum.showNotification('Save feature coming soon!', 'info');
    }
}

// Sort functionality
function updateSort(sortBy) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

// Auto-resize textarea
const textarea = document.querySelector('#comment-content');
if (textarea) {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.max(80, this.scrollHeight) + 'px';
    });
}

// Helper functions for template
function sub(a, b) { return a - b; }
function add(a, b) { return a + b; }

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('share-modal');
    if (e.target === modal) {
        closeModal('share-modal');
    }
});
</script>

<style>
/* Enhanced Comment Styles */
.comments-section {
    margin-top: 20px;
}

.comments-header {
    background: white;
    border-radius: 8px 8px 0 0;
    padding: 16px 20px;
    border-bottom: 1px solid #edeff1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comments-sort {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.comments-sort select {
    padding: 4px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

.comment-form-container {
    background: white;
    border-bottom: 1px solid #edeff1;
    padding: 16px 20px;
}

.comment-form-header {
    margin-bottom: 12px;
    font-size: 14px;
    color: #878a8c;
}

.comment-input-area {
    border: 2px solid #edeff1;
    border-radius: 4px;
    transition: border-color 0.2s;
    margin-bottom: 12px;
}

.comment-input-area:focus-within {
    border-color: #0079d3;
}

.comment-input-area textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: none;
    outline: none;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    background: transparent;
}

.comment-form-actions {
    display: flex;
    justify-content: flex-end;
}

.comment-item {
    display: flex;
    gap: 12px;
    background: white;
    padding: 16px 20px;
    border-bottom: 1px solid #edeff1;
}

.comment-vote-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    min-width: 32px;
}

.comment-vote-btn {
    width: 24px;
    height: 24px;
    border: none;
    background: none;
    cursor: pointer;
    color: #878a8c;
    transition: all 0.2s;
    border-radius: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
}

.comment-vote-btn:hover {
    background: #f6f7f8;
    color: #1a1a1b;
}

.comment-vote-btn.active {
    color: #ff4500;
}

.comment-score {
    font-size: 12px;
    font-weight: 700;
    color: #878a8c;
}

.comment-content-section {
    flex: 1;
}

.comment-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 12px;
}

.comment-author {
    font-weight: 700;
    color: #0079d3;
    text-decoration: none;
}

.comment-author:hover {
    text-decoration: underline;
}

.comment-score-inline {
    color: #878a8c;
}

.comment-time {
    color: #878a8c;
}

.comment-content {
    margin-bottom: 8px;
    color: #1a1a1b;
    line-height: 1.5;
}

.comment-actions {
    display: flex;
    align-items: center;
    gap: 16px;
}

.comment-action-btn {
    background: none;
    border: none;
    color: #878a8c;
    cursor: pointer;
    font-size: 12px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 2px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
}

.comment-action-btn:hover {
    background: #f6f7f8;
    color: #1a1a1b;
}

.comment-action-btn.danger:hover {
    color: #e74c3c;
}

.reply-form {
    margin-top: 12px;
    margin-left: 20px;
    border-left: 2px solid #edeff1;
    padding-left: 12px;
}

.reply-form textarea {
    width: 100%;
    min-height: 60px;
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    margin-bottom: 8px;
}

.reply-form-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.empty-comments {
    background: white;
    padding: 60px 20px;
    text-align: center;
    color: #878a8c;
    border-radius: 0 0 8px 8px;
}

.empty-comments i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-comments h3 {
    margin-bottom: 8px;
    color: #1a1a1b;
}

.closed-notice {
    background: #fff3cd;
    color: #856404;
    padding: 16px 20px;
    text-align: center;
    border-bottom: 1px solid #edeff1;
}

.login-prompt {
    background: white;
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid #edeff1;
}

.auth-buttons {
    margin-top: 12px;
    display: flex;
    gap: 12px;
    justify-content: center;
}

.user-link {
    color: #0079d3;
    text-decoration: none;
    font-weight: 500;
}

.user-link:hover {
    text-decoration: underline;
}

/* Thread-specific styles */
.thread-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 12px;
    line-height: 1.3;
    color: #1a1a1b;
}

.thread-description {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 16px;
    margin-bottom: 12px;
    border-left: 4px solid #0079d3;
}

.thread-description p {
    margin: 0;
    color: #1a1a1b;
    line-height: 1.5;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .comment-item {
        padding: 12px 16px;
        gap: 8px;
    }
    
    .comment-vote-section {
        min-width: 28px;
    }
    
    .comment-vote-btn {
        width: 20px;
        height: 20px;
    }
    
    .comment-actions {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .reply-form {
        margin-left: 12px;
        padding-left: 8px;
    }
    
    .auth-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .thread-container {
        padding: 0 12px;
    }
}
</style>
{{end}}