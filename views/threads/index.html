{{define "content"}}
<div class="forum-container">
    <div class="forum-sidebar">
        <div class="sidebar-section">
            <h3><i class="fas fa-home"></i> Home</h3>
            <div class="tag-list">
                <a href="/" class="tag-item {{if not .Filters.TagName}}active{{end}}">
                    <i class="fas fa-fire"></i> Popular
                </a>
                <a href="/?sort=new" class="tag-item">
                    <i class="fas fa-clock"></i> New
                </a>
                <a href="/?sort=top" class="tag-item">
                    <i class="fas fa-arrow-up"></i> Top
                </a>
            </div>
        </div>
        <div class="sidebar-section">
            <h3><i class="fas fa-search"></i> Search</h3>
            <form action="/search" method="get" class="search-form">
                <input type="text" name="q" placeholder="Search threads..." class="search-input">
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>
        <div class="sidebar-section">
            <h3><i class="fas fa-tags"></i> Communities</h3>
            <div class="tag-list">
                <a href="/" class="tag-item {{if not .Filters.TagName}}active{{end}}">
                    <i class="fas fa-home"></i> All Communities
                </a>
                {{range .Tags}}
                <a href="/?tag={{.Name}}" class="tag-item {{if eq $.Filters.TagName .Name}}active{{end}}">
                    <i class="fas fa-hashtag"></i> r/{{.Name}}
                </a>
                {{end}}
            </div>
        </div>

        {{if .User}}
        <div class="sidebar-section">
            <h3><i class="fas fa-plus"></i> Create</h3>
            <a href="/threads/create" class="btn btn-primary btn-full">
                <i class="fas fa-plus"></i> Create Post
            </a>
        </div>
        {{end}}
    </div>

    <div class="forum-main">
        <div class="forum-header">
            <div class="forum-title">
                <h1>
                    {{if .Filters.TagName}}
                        <i class="fas fa-hashtag"></i> r/{{.Filters.TagName}}
                    {{else if .Filters.Search}}
                        <i class="fas fa-search"></i> Search: "{{.Filters.Search}}"
                    {{else}}
                        <i class="fas fa-home"></i> Popular Posts
                    {{end}}
                </h1>
                <p>{{.Pagination.TotalItems}} posts</p>
            </div>
        </div>

        <div class="thread-filters">
            <div class="filter-group">
                <select id="sort-select" onchange="updateSort(this.value)">
                    <option value="hot" {{if eq .Filters.SortBy "hot"}}selected{{end}}>üî• Hot</option>
                    <option value="new" {{if eq .Filters.SortBy "new"}}selected{{end}}>üÜï New</option>
                    <option value="top" {{if eq .Filters.SortBy "top"}}selected{{end}}>‚¨ÜÔ∏è Top</option>
                </select>
                
                <select id="limit-select" onchange="updateLimit(this.value)">
                    <option value="10" {{if eq .Pagination.ItemsPerPage 10}}selected{{end}}>10 posts</option>
                    <option value="25" {{if eq .Pagination.ItemsPerPage 25}}selected{{end}}>25 posts</option>
                    <option value="50" {{if eq .Pagination.ItemsPerPage 50}}selected{{end}}>50 posts</option>
                </select>
            </div>
        </div>

        <div class="thread-list">
            {{if .Threads}}
                {{range .Threads}}
                <div class="thread-card" data-thread-id="{{.ID}}">
                    <div class="thread-content-wrapper">
                        <div class="thread-vote-section">
                            {{if $.User}}
                                <button class="vote-arrow {{if eq .UserVote 1}}upvoted{{end}}" onclick="voteThread('{{.ID}}', 1)" title="Upvote">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                            {{else}}
                                <a href="/login" class="vote-arrow" title="Login to vote">
                                    <i class="fas fa-arrow-up"></i>
                                </a>
                            {{end}}
                            
                            <div class="vote-score" data-thread-id="{{.ID}}" data-score="{{.Score}}">{{.Score}}</div>
                            
                            {{if $.User}}
                                <button class="vote-arrow {{if eq .UserVote -1}}downvoted{{end}}" onclick="voteThread('{{.ID}}', -1)" title="Downvote">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                            {{else}}
                                <a href="/login" class="vote-arrow" title="Login to vote">
                                    <i class="fas fa-arrow-down"></i>
                                </a>
                            {{end}}
                        </div>
                        
                        <div class="thread-main-content">
                            <div class="thread-meta-line">
                                {{range .Tags}}
                                    <a href="/?tag={{.Name}}" class="community-link">r/{{.Name}}</a>
                                {{end}}
                                <span>‚Ä¢</span>
                                <span>Posted by 
                                    <div class="inline-user-info">
                                        <div class="user-avatar-small {{getAvatarClass (getAvatarStyle .Author)}}">
                                            {{if .Author.AvatarURL}}
                                                <img src="{{.Author.AvatarURL}}" alt="{{.Author.Username}}" class="avatar-img">
                                            {{else}}
                                                <span class="avatar-initial">{{getUserInitial .Author}}</span>
                                            {{end}}
                                        </div>
                                        <a href="/user/{{.Author.Username}}" class="user-link">u/{{.Author.Username}}</a>
                                    </div>
                                </span>
                                <span>‚Ä¢</span>
                                <span title="{{.CreatedAt.Format "Jan 02, 2006 15:04:05"}}">{{timeAgo .CreatedAt}}</span>
                                {{if eq .Status "closed"}}
                                    <span class="status-badge">üîí Closed</span>
                                {{end}}
                                {{if ne .PostType "text"}}
                                    <span class="post-type-badge post-type-{{.PostType}}">
                                        {{if eq .PostType "image"}}üì∑{{else if eq .PostType "link"}}üîó{{end}}
                                        {{upper .PostType}}
                                    </span>
                                {{end}}
                            </div>
                            
                            <a href="/threads/{{.ID}}" class="thread-title-link">
                                {{.Title}}
                            </a>
                            
                            {{/* Show different content based on post type */}}
                            {{if eq .PostType "image"}}
                                {{if .ImageURL}}
                                <div class="thread-image-preview">
                                    <img src="{{.ImageURL}}" alt="{{.Title}}" class="preview-image" onclick="openImageModal(this.src)" loading="lazy">
                                </div>
                                {{end}}
                                {{if .Description}}
                                <div class="thread-preview">
                                    {{truncate .Description 150}}
                                </div>
                                {{end}}
                            {{else if eq .PostType "link"}}
                                {{if .LinkURL}}
                                <div class="thread-link-preview">
                                    <div class="link-preview-compact">
                                        <i class="fas fa-external-link-alt"></i>
                                        <span class="link-domain">{{.LinkURL}}</span>
                                        <a href="{{.LinkURL}}" target="_blank" rel="noopener" class="link-visit-btn" onclick="event.stopPropagation()">
                                            <i class="fas fa-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                                {{end}}
                                {{if .Description}}
                                <div class="thread-preview">
                                    {{truncate .Description 200}}
                                </div>
                                {{end}}
                            {{else}}
                                {{/* Text post */}}
                                {{if .Description}}
                                <div class="thread-preview">
                                    {{truncate .Description 200}}
                                </div>
                                {{end}}
                            {{end}}
                            
                            <div class="thread-footer">
                                <div class="thread-action" onclick="window.location.href='/threads/{{.ID}}'">
                                    <i class="fas fa-comment"></i>
                                    <span>{{.MessageCount}} comments</span>
                                </div>
                                
                                <div class="thread-action" onclick="shareThread('{{.ID}}')">
                                    <i class="fas fa-share"></i>
                                    <span>Share</span>
                                </div>
                                
                                <div class="thread-action" onclick="saveThread('{{.ID}}')">
                                    <i class="fas fa-bookmark"></i>
                                    <span>Save</span>
                                </div>
                                
                                {{if $.User}}
                                    {{if or (eq $.User.ID .AuthorID) (eq $.User.Role "admin")}}
                                    <div class="thread-action" onclick="showThreadOptions('{{.ID}}')">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </div>
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                    </div>
                </div>
                {{end}}
            {{else}}
                <div class="empty-state">
                    <i class="fas fa-comment-slash"></i>
                    <h3>No posts found</h3>
                    <p>
                        {{if .Filters.Search}}
                            No posts match your search criteria.
                        {{else if .Filters.TagName}}
                            No posts in r/{{.Filters.TagName}} yet.
                        {{else}}
                            No posts have been created yet.
                        {{end}}
                    </p>
                    {{if .User}}
                        <a href="/threads/create" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create the first post
                        </a>
                    {{else}}
                        <div>
                            <a href="/login" class="btn btn-outline">Login</a>
                            <span> or </span>
                            <a href="/register" class="btn btn-primary">Sign Up</a>
                            <span> to create posts</span>
                        </div>
                    {{end}}
                </div>
            {{end}}
        </div>

        {{if gt .Pagination.TotalPages 1}}
        <div class="pagination">
            {{if .Pagination.HasPrev}}
                <a href="?page={{sub .Pagination.CurrentPage 1}}{{if .Filters.TagName}}&tag={{.Filters.TagName}}{{end}}{{if .Filters.Search}}&search={{.Filters.Search}}{{end}}{{if .Filters.SortBy}}&sort={{.Filters.SortBy}}{{end}}" class="pagination-btn">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            {{end}}
            
            <span class="pagination-info">
                Page {{.Pagination.CurrentPage}} of {{.Pagination.TotalPages}}
                ({{.Pagination.TotalItems}} total posts)
            </span>
            
            {{if .Pagination.HasNext}}
                <a href="?page={{add .Pagination.CurrentPage 1}}{{if .Filters.TagName}}&tag={{.Filters.TagName}}{{end}}{{if .Filters.Search}}&search={{.Filters.Search}}{{end}}{{if .Filters.SortBy}}&sort={{.Filters.SortBy}}{{end}}" class="pagination-btn">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            {{end}}
        </div>
        {{end}}
    </div>
</div>

<!-- Advanced Image Modal with Zoom -->
<div id="image-modal" class="image-modal" style="display: none;">
    <div class="image-modal-overlay" onclick="closeImageModal()"></div>
    <div class="image-modal-container">
        <div class="image-modal-header">
            <div class="image-modal-title">Image Viewer</div>
            <div class="image-modal-controls">
                <button class="modal-control-btn" onclick="resetZoom()" title="Reset Zoom">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
                <button class="modal-control-btn" onclick="downloadImage()" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="modal-control-btn" onclick="closeImageModal()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="image-modal-content" id="image-container">
            <img id="modal-image" src="" alt="" draggable="false">
            <div class="zoom-indicator" id="zoom-indicator">100%</div>
        </div>
        <div class="image-modal-footer">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="zoom-level" id="zoom-level">100%</span>
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="modal-instructions">
                <span><i class="fas fa-mouse-pointer"></i> Drag to pan</span>
                <span><i class="fas fa-mouse"></i> Scroll to zoom</span>
                <span><kbd>Esc</kbd> to close</span>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Share Modal -->
<div id="share-modal" class="share-modal" style="display: none;">
    <div class="share-modal-overlay" onclick="closeModal('share-modal')"></div>
    <div class="share-modal-content">
        <div class="share-modal-header">
            <h3><i class="fas fa-share-alt"></i> Share Post</h3>
            <button class="share-modal-close" onclick="closeModal('share-modal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="share-modal-body">
            <!-- Link Sharing Section -->
            <div class="share-section">
                <h4><i class="fas fa-link"></i> Share Link</h4>
                <div class="share-link-container">
                    <input type="text" id="share-link-input" readonly placeholder="Loading...">
                    <button onclick="copyShareLink()" class="copy-btn" title="Copy Link">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <!-- Social Media Sharing -->
            <div class="share-section">
                <h4><i class="fas fa-share-nodes"></i> Share on Social Media</h4>
                <div class="social-share-grid">
                    <button class="social-share-btn reddit" onclick="shareToReddit()">
                        <i class="fab fa-reddit-alien"></i>
                        <span>Reddit</span>
                    </button>
                    <button class="social-share-btn twitter" onclick="shareToTwitter()">
                        <i class="fab fa-twitter"></i>
                        <span>Twitter</span>
                    </button>
                    <button class="social-share-btn facebook" onclick="shareToFacebook()">
                        <i class="fab fa-facebook"></i>
                        <span>Facebook</span>
                    </button>
                    <button class="social-share-btn discord" onclick="shareToDiscord()">
                        <i class="fab fa-discord"></i>
                        <span>Discord</span>
                    </button>
                    <button class="social-share-btn telegram" onclick="shareToTelegram()">
                        <i class="fab fa-telegram"></i>
                        <span>Telegram</span>
                    </button>
                    <button class="social-share-btn whatsapp" onclick="shareToWhatsApp()">
                        <i class="fab fa-whatsapp"></i>
                        <span>WhatsApp</span>
                    </button>
                </div>
            </div>
            
            <!-- Cross-post Section -->
            {{if .User}}
            <div class="share-section">
                <h4><i class="fas fa-arrows-alt"></i> Cross-post to Community</h4>
                <div class="crosspost-container">
                    <select id="crosspost-community" class="crosspost-select">
                        <option value="">Select a community...</option>
                        {{range .Tags}}
                        <option value="{{.Name}}">r/{{.Name}}</option>
                        {{end}}
                    </select>
                    <button onclick="createCrossPost()" class="crosspost-btn">
                        <i class="fas fa-plus"></i>
                        Cross-post
                    </button>
                </div>
                <small class="crosspost-note">
                    <i class="fas fa-info-circle"></i>
                    Cross-posting will create a new post in the selected community that links back to this original post
                </small>
            </div>
            {{end}}
            
            <!-- QR Code Section -->
            <div class="share-section">
                <h4><i class="fas fa-qrcode"></i> QR Code</h4>
                <div class="qr-container">
                    <div id="qr-code" class="qr-placeholder">
                        <i class="fas fa-qrcode"></i>
                        <span>QR Code</span>
                        <small>Scan to share</small>
                    </div>
                    <button onclick="downloadQR()" class="qr-download-btn">
                        <i class="fas fa-download"></i>
                        Download QR
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentShareThreadId = null;

// Advanced Image modal functions with zoom and pan
let currentZoom = 1;
let isDragging = false;
let startX, startY, scrollLeft, scrollTop;

function openImageModal(imageSrc) {
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const container = document.getElementById('image-container');
    
    modalImage.src = imageSrc;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Reset zoom and position
    currentZoom = 1;
    updateZoom();
    container.scrollLeft = 0;
    container.scrollTop = 0;
    
    // Add event listeners
    addImageEventListeners();
}

function closeImageModal() {
    const modal = document.getElementById('image-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    removeImageEventListeners();
}

function addImageEventListeners() {
    const container = document.getElementById('image-container');
    const modalImage = document.getElementById('modal-image');
    
    // Scroll wheel zoom
    container.addEventListener('wheel', handleZoom, { passive: false });
    
    // Drag to pan
    container.addEventListener('mousedown', startDrag);
    container.addEventListener('mousemove', drag);
    container.addEventListener('mouseup', endDrag);
    container.addEventListener('mouseleave', endDrag);
    
    // Touch support for mobile
    container.addEventListener('touchstart', handleTouchStart, { passive: false });
    container.addEventListener('touchmove', handleTouchMove, { passive: false });
    container.addEventListener('touchend', handleTouchEnd);
    
    // Double click to zoom
    modalImage.addEventListener('dblclick', handleDoubleClick);
}

function removeImageEventListeners() {
    const container = document.getElementById('image-container');
    const modalImage = document.getElementById('modal-image');
    
    container.removeEventListener('wheel', handleZoom);
    container.removeEventListener('mousedown', startDrag);
    container.removeEventListener('mousemove', drag);
    container.removeEventListener('mouseup', endDrag);
    container.removeEventListener('mouseleave', endDrag);
    container.removeEventListener('touchstart', handleTouchStart);
    container.removeEventListener('touchmove', handleTouchMove);
    container.removeEventListener('touchend', handleTouchEnd);
    modalImage.removeEventListener('dblclick', handleDoubleClick);
}

function handleZoom(e) {
    e.preventDefault();
    
    const container = document.getElementById('image-container');
    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const oldZoom = currentZoom;
    const zoomSpeed = 0.1;
    
    if (e.deltaY < 0) {
        // Zoom in
        currentZoom = Math.min(currentZoom + zoomSpeed, 5);
    } else {
        // Zoom out
        currentZoom = Math.max(currentZoom - zoomSpeed, 0.1);
    }
    
    // Calculate new scroll position to zoom towards cursor
    const zoomRatio = currentZoom / oldZoom;
    const newScrollLeft = (container.scrollLeft + x) * zoomRatio - x;
    const newScrollTop = (container.scrollTop + y) * zoomRatio - y;
    
    updateZoom();
    
    container.scrollLeft = newScrollLeft;
    container.scrollTop = newScrollTop;
}

function startDrag(e) {
    const container = document.getElementById('image-container');
    isDragging = true;
    container.style.cursor = 'grabbing';
    startX = e.pageX - container.offsetLeft;
    startY = e.pageY - container.offsetTop;
    scrollLeft = container.scrollLeft;
    scrollTop = container.scrollTop;
}

function drag(e) {
    if (!isDragging) return;
    e.preventDefault();
    
    const container = document.getElementById('image-container');
    const x = e.pageX - container.offsetLeft;
    const y = e.pageY - container.offsetTop;
    const walkX = (x - startX) * 1;
    const walkY = (y - startY) * 1;
    
    container.scrollLeft = scrollLeft - walkX;
    container.scrollTop = scrollTop - walkY;
}

function endDrag() {
    isDragging = false;
    const container = document.getElementById('image-container');
    container.style.cursor = currentZoom > 1 ? 'grab' : 'default';
}

function handleDoubleClick(e) {
    if (currentZoom === 1) {
        currentZoom = 2;
    } else {
        currentZoom = 1;
    }
    updateZoom();
    centerImage();
}

function zoomIn() {
    currentZoom = Math.min(currentZoom + 0.25, 5);
    updateZoom();
}

function zoomOut() {
    currentZoom = Math.max(currentZoom - 0.25, 0.1);
    updateZoom();
}

function resetZoom() {
    currentZoom = 1;
    updateZoom();
    centerImage();
}

function updateZoom() {
    const modalImage = document.getElementById('modal-image');
    const zoomLevel = document.getElementById('zoom-level');
    const zoomIndicator = document.getElementById('zoom-indicator');
    const container = document.getElementById('image-container');
    
    modalImage.style.transform = `scale(${currentZoom})`;
    const percentage = Math.round(currentZoom * 100);
    zoomLevel.textContent = `${percentage}%`;
    zoomIndicator.textContent = `${percentage}%`;
    
    // Update cursor
    container.style.cursor = currentZoom > 1 ? 'grab' : 'default';
    
    // Show/hide zoom indicator
    if (currentZoom !== 1) {
        zoomIndicator.style.opacity = '1';
        setTimeout(() => {
            zoomIndicator.style.opacity = '0';
        }, 1000);
    }
}

function centerImage() {
    const container = document.getElementById('image-container');
    const modalImage = document.getElementById('modal-image');
    
    setTimeout(() => {
        const containerRect = container.getBoundingClientRect();
        const imageRect = modalImage.getBoundingClientRect();
        
        const scrollLeft = (imageRect.width * currentZoom - containerRect.width) / 2;
        const scrollTop = (imageRect.height * currentZoom - containerRect.height) / 2;
        
        container.scrollLeft = Math.max(0, scrollLeft);
        container.scrollTop = Math.max(0, scrollTop);
    }, 10);
}

function downloadImage() {
    const modalImage = document.getElementById('modal-image');
    const link = document.createElement('a');
    link.href = modalImage.src;
    link.download = 'image.jpg';
    link.click();
}

// Touch support for mobile
let touchStartX, touchStartY, touchDistance = 0;

function handleTouchStart(e) {
    if (e.touches.length === 1) {
        // Single touch - start dragging
        const touch = e.touches[0];
        startDrag({
            pageX: touch.pageX,
            pageY: touch.pageY
        });
    } else if (e.touches.length === 2) {
        // Two touches - prepare for pinch zoom
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        touchDistance = Math.sqrt(
            Math.pow(touch2.pageX - touch1.pageX, 2) +
            Math.pow(touch2.pageY - touch1.pageY, 2)
        );
    }
}

function handleTouchMove(e) {
    e.preventDefault();
    
    if (e.touches.length === 1 && isDragging) {
        // Single touch - dragging
        const touch = e.touches[0];
        drag({
            pageX: touch.pageX,
            pageY: touch.pageY,
            preventDefault: () => {}
        });
    } else if (e.touches.length === 2) {
        // Two touches - pinch zoom
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const newDistance = Math.sqrt(
            Math.pow(touch2.pageX - touch1.pageX, 2) +
            Math.pow(touch2.pageY - touch1.pageY, 2)
        );
        
        if (touchDistance > 0) {
            const scale = newDistance / touchDistance;
            currentZoom = Math.max(0.1, Math.min(5, currentZoom * scale));
            updateZoom();
        }
        
        touchDistance = newDistance;
    }
}

function handleTouchEnd(e) {
    if (e.touches.length === 0) {
        endDrag();
        touchDistance = 0;
    }
}

// Close image modal with escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// Helper function for time ago
function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return 'just now';
    if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'm ago';
    if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'h ago';
    if (diffInSeconds < 2592000) return Math.floor(diffInSeconds / 86400) + 'd ago';
    return date.toLocaleDateString();
}

// Truncate text
function truncate(text, length) {
    return text.length > length ? text.substring(0, length) + '...' : text;
}

// Update sort
function updateSort(sortBy) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

// Update limit
function updateLimit(limit) {
    const url = new URL(window.location);
    url.searchParams.set('limit', limit);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

// Vote on thread
async function voteThread(threadId, voteType) {
    try {
        const response = await fetch(`/api/threads/${threadId}/vote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ vote_type: voteType })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Update the vote display
            const threadCard = document.querySelector(`[data-thread-id="${threadId}"]`);
            if (threadCard) {
                const scoreElement = threadCard.querySelector('.vote-score');
                const upvoteBtn = threadCard.querySelector('.vote-arrow:first-child');
                const downvoteBtn = threadCard.querySelector('.vote-arrow:last-child');
                
                // Update score
                scoreElement.textContent = result.score;
                scoreElement.dataset.score = result.score;
                
                // Update button states
                upvoteBtn.classList.toggle('upvoted', result.user_vote === 1);
                downvoteBtn.classList.toggle('downvoted', result.user_vote === -1);
                
                // Add visual feedback
                const feedbackClass = voteType === 1 ? 'vote-feedback-up' : 'vote-feedback-down';
                scoreElement.classList.add(feedbackClass);
                setTimeout(() => {
                    scoreElement.classList.remove(feedbackClass);
                }, 300);
            }
            
            if (window.GoForum) {
                const action = result.user_vote === voteType ? 
                    (voteType === 1 ? 'upvoted' : 'downvoted') : 'removed vote';
                GoForum.showNotification(`Post ${action}!`, 'success');
            }
        } else {
            const result = await response.text();
            if (window.GoForum) {
                GoForum.showNotification(result, 'error');
            }
        }
    } catch (error) {
        console.error('Error voting:', error);
        if (window.GoForum) {
            GoForum.showNotification('Failed to vote. Please try again.', 'error');
        }
    }
}

// Enhanced Share Functions
function shareThread(threadId) {
    currentShareThreadId = threadId;
    const shareUrl = `${window.location.origin}/threads/${threadId}`;
    document.getElementById('share-link-input').value = shareUrl;
    document.getElementById('share-modal').style.display = 'flex';
    generateQRCode(shareUrl);
}

function copyShareLink() {
    const input = document.getElementById('share-link-input');
    input.select();
    input.setSelectionRange(0, 99999);
    
    navigator.clipboard.writeText(input.value).then(() => {
        showCopyFeedback();
        if (window.GoForum) {
            GoForum.showNotification('Link copied to clipboard!', 'success');
        }
    }).catch(() => {
        // Fallback for older browsers
        document.execCommand('copy');
        showCopyFeedback();
        if (window.GoForum) {
            GoForum.showNotification('Link copied to clipboard!', 'success');
        }
    });
}

function showCopyFeedback() {
    const copyBtn = document.querySelector('.copy-btn');
    const originalHTML = copyBtn.innerHTML;
    copyBtn.innerHTML = '<i class="fas fa-check"></i>';
    copyBtn.style.background = '#28a745';
    
    setTimeout(() => {
        copyBtn.innerHTML = originalHTML;
        copyBtn.style.background = '';
    }, 1500);
}

// Enhanced Social Sharing Functions
function shareToReddit() {
    const url = document.getElementById('share-link-input').value;
    const title = `Check out this post on GoForum!`;
    window.open(`https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`, '_blank');
}

function shareToTwitter() {
    const url = document.getElementById('share-link-input').value;
    const text = 'Check out this interesting post on GoForum! üöÄ';
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
}

function shareToFacebook() {
    const url = document.getElementById('share-link-input').value;
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
}

function shareToDiscord() {
    const url = document.getElementById('share-link-input').value;
    // Discord doesn't have direct sharing URL, so we copy and show instruction
    navigator.clipboard.writeText(url);
    if (window.GoForum) {
        GoForum.showNotification('Link copied! Paste it in Discord üí¨', 'info');
    }
}

function shareToTelegram() {
    const url = document.getElementById('share-link-input').value;
    const text = 'Check out this post on GoForum!';
    window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
}

function shareToWhatsApp() {
    const url = document.getElementById('share-link-input').value;
    const text = `Check out this interesting post: ${url}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

// Cross-post functionality
async function createCrossPost() {
    const community = document.getElementById('crosspost-community').value;
    if (!community) {
        if (window.GoForum) {
            GoForum.showNotification('Please select a community first', 'warning');
        }
        return;
    }
    
    if (!currentShareThreadId) {
        if (window.GoForum) {
            GoForum.showNotification('No post selected for cross-posting', 'error');
        }
        return;
    }
    
    // For now, redirect to create page with pre-filled data
    // In a real implementation, you'd make an API call to create the cross-post
    const originalUrl = `${window.location.origin}/threads/${currentShareThreadId}`;
    const crossPostUrl = `/threads/create?crosspost=${currentShareThreadId}&community=${community}`;
    
    if (window.GoForum) {
        GoForum.showNotification(`Cross-posting to r/${community}...`, 'info');
    }
    
    // Close modal and redirect
    setTimeout(() => {
        closeModal('share-modal');
        window.location.href = crossPostUrl;
    }, 1000);
}

// QR Code generation (simple text-based for now)
function generateQRCode(url) {
    const qrContainer = document.getElementById('qr-code');
    // In a real implementation, you'd use a QR code library like qrcode.js
    // For now, we'll show a placeholder that links to a QR generator
    qrContainer.innerHTML = `
        <div class="qr-placeholder-content">
            <i class="fas fa-qrcode"></i>
            <span>QR Code</span>
            <small>Click to generate</small>
        </div>
    `;
    
    qrContainer.onclick = () => {
        window.open(`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`, '_blank');
    };
}

function downloadQR() {
    const url = document.getElementById('share-link-input').value;
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&format=png&data=${encodeURIComponent(url)}`;
    
    const link = document.createElement('a');
    link.href = qrUrl;
    link.download = 'goforum-post-qr.png';
    link.click();
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Save thread (placeholder)
function saveThread(threadId) {
    if (window.GoForum) {
        GoForum.showNotification('Save feature coming soon!', 'info');
    }
}

// Show thread options
function showThreadOptions(threadId) {
    const options = [
        'Edit Post',
        'Delete Post',
        'Pin Post',
        'Lock Comments'
    ];
    
    // Simple implementation - you can enhance this with a proper dropdown
    const action = prompt('Choose action:\n' + options.join('\n'));
    
    if (action) {
        if (window.GoForum) {
            GoForum.showNotification(`${action} feature coming soon!`, 'info');
        }
    }
}

// Template helper functions
function sub(a, b) { return a - b; }
function add(a, b) { return a + b; }

// Close modal when clicking outside, enhanced for new modal
document.addEventListener('click', function(e) {
    const shareModal = document.getElementById('share-modal');
    const imageModal = document.getElementById('image-modal');
    
    if (e.target === shareModal || e.target.classList.contains('share-modal-overlay')) {
        closeModal('share-modal');
    }
    
    if (e.target === imageModal || e.target.classList.contains('image-modal-overlay')) {
        closeImageModal();
    }
    
    // Prevent image clicks from bubbling up
    if (e.target.classList.contains('preview-image')) {
        e.stopPropagation();
    }
});

// Initialize time ago updates
setInterval(() => {
    document.querySelectorAll('[title*="2024"]').forEach(el => {
        const date = new Date(el.getAttribute('title'));
        el.textContent = timeAgo(date);
    });
}, 60000); // Update every minute

// Stop propagation on preview images so clicking them doesn't navigate to thread
document.querySelectorAll('.preview-image').forEach(img => {
    img.addEventListener('click', function(e) {
        e.stopPropagation();
        e.preventDefault();
    });
});
</script>

<style>
/* Enhanced styles for image and link previews in home page */
.post-type-badge {
    background: #0079d3;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    margin-left: 8px;
}

.post-type-badge.post-type-image {
    background: #ff6b35;
}

.post-type-badge.post-type-link {
    background: #2ecc71;
}

/* Image preview in thread list - Reddit style */
.thread-image-preview {
    margin: 12px 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #edeff1;
    background: #000;
    position: relative;
    width: 100%;
    max-width: 512px;
    aspect-ratio: 16/10;
    display: flex;
    align-items: center;
    justify-content: center;
}

.preview-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
    cursor: zoom-in;
    transition: all 0.2s ease;
    background: #000;
}

.preview-image:hover {
    transform: scale(1.02);
}

/* Link preview in thread list */
.thread-link-preview {
    margin: 12px 0;
}

.link-preview-compact {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border: 1px solid #edeff1;
    border-radius: 6px;
    transition: all 0.2s;
}

.link-preview-compact:hover {
    background: #f0f0f0;
    border-color: #0079d3;
}

.link-preview-compact i {
    color: #0079d3;
    font-size: 16px;
    flex-shrink: 0;
}

.link-domain {
    flex: 1;
    color: #1a1a1b;
    font-weight: 500;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.link-visit-btn {
    background: #0079d3;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    flex-shrink: 0;
}

.link-visit-btn:hover {
    background: #005fa3;
    color: white;
}

/* Advanced Image Modal Styles */
.image-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    flex-direction: column;
    z-index: 10000;
    opacity: 0;
    animation: modalFadeIn 0.3s ease-out forwards;
}

@keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.image-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.image-modal-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    pointer-events: none;
}

.image-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
    color: white;
    pointer-events: all;
    z-index: 2;
}

.image-modal-title {
    font-size: 18px;
    font-weight: 600;
}

.image-modal-controls {
    display: flex;
    gap: 8px;
}

.modal-control-btn {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.modal-control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
    transform: scale(1.05);
}

.image-modal-content {
    flex: 1;
    position: relative;
    overflow: hidden;
    pointer-events: all;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-modal-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.2s ease;
    transform-origin: center center;
    user-select: none;
}

.zoom-indicator {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    backdrop-filter: blur(10px);
}

.image-modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    color: white;
    pointer-events: all;
}

.zoom-controls {
    display: flex;
    align-items: center;
    gap: 16px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    padding: 8px 16px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.zoom-btn {
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.zoom-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.zoom-level {
    font-size: 14px;
    font-weight: 600;
    min-width: 50px;
    text-align: center;
}

.modal-instructions {
    display: flex;
    gap: 20px;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.8);
}

.modal-instructions span {
    display: flex;
    align-items: center;
    gap: 6px;
}

.modal-instructions kbd {
    background: rgba(255, 255, 255, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

/* Scrollbar styling for image container */
.image-modal-content::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.image-modal-content::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.image-modal-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
}

.image-modal-content::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .image-modal-header,
    .image-modal-footer {
        padding: 12px 16px;
    }
    
    .modal-instructions {
        display: none;
    }
    
    .image-modal-title {
        font-size: 16px;
    }
    
    .modal-control-btn,
    .zoom-btn {
        width: 40px;
        height: 40px;
    }
    
    .zoom-controls {
        gap: 12px;
        padding: 6px 12px;
    }
    
    .zoom-indicator {
        top: 15px;
        right: 15px;
        font-size: 12px;
        padding: 6px 12px;
    }
}

/* Enhanced thread card styles - Reddit-like */
.thread-card {
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
    transition: all 0.2s ease;
    cursor: pointer;
    display: flex;
    position: relative;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.thread-card:hover {
    border-color: #898989;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.thread-content-wrapper {
    display: flex;
    width: 100%;
}

.thread-vote-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #f8f9fa;
    padding: 8px;
    min-width: 40px;
    border-right: 1px solid #edeff1;
}

.vote-arrow {
    width: 24px;
    height: 24px;
    border: none;
    background: none;
    cursor: pointer;
    color: #878a8c;
    transition: all 0.1s;
    border-radius: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
}

.vote-arrow:hover {
    background: #f6f7f8;
    color: #1a1a1b;
}

.vote-arrow.upvoted {
    color: #ff4500;
}

.vote-arrow.downvoted {
    color: #7193ff;
}

.vote-score {
    font-size: 12px;
    font-weight: 700;
    color: #1a1a1b;
    margin: 2px 0;
    text-align: center;
}

.thread-main-content {
    flex: 1;
    padding: 12px;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.thread-meta-line {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #878a8c;
    margin-bottom: 4px;
    flex-wrap: wrap;
}

.community-link {
    color: #1a1a1b;
    font-weight: 700;
    text-decoration: none;
    font-size: 12px;
}

.community-link:hover {
    text-decoration: underline;
}

.thread-title-link {
    color: #1a1a1b;
    font-size: 18px;
    font-weight: 500;
    text-decoration: none;
    line-height: 1.3;
    display: block;
    margin-bottom: 8px;
}

.thread-title-link:hover {
    text-decoration: underline;
}

.thread-title-link:visited {
    color: #9b9b9b;
}

.thread-preview {
    color: #878a8c;
    font-size: 14px;
    line-height: 1.4;
    margin-bottom: 8px;
    overflow: hidden;
}

.thread-footer {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
    color: #878a8c;
    margin-top: auto;
}

.thread-action {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 4px;
    border-radius: 2px;
    cursor: pointer;
    transition: background-color 0.2s;
    color: #878a8c;
    text-decoration: none;
}

.thread-action:hover {
    background: #f6f7f8;
    color: #1a1a1b;
}

/* Loading states */
.preview-image[src=""],
.preview-image:not([src]) {
    background: #f0f0f0;
    color: #999;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 200px;
}

.preview-image[src=""]:before,
.preview-image:not([src]):before {
    content: "Loading...";
}

/* Responsive Design */
@media (max-width: 768px) {
    .thread-content-wrapper {
        flex-direction: column;
    }
    
    .thread-vote-section {
        flex-direction: row;
        justify-content: center;
        min-width: unset;
        padding: 8px 16px;
        border-right: none;
        border-bottom: 1px solid #edeff1;
    }
    
    .vote-score {
        margin: 0 8px;
    }
    
    .thread-main-content {
        padding: 12px;
    }
    
    .thread-image-preview {
        aspect-ratio: 16/9;
        max-width: 100%;
    }
    
    .preview-image {
        object-fit: contain;
    }
    
    .link-preview-compact {
        flex-direction: column;
        text-align: center;
        gap: 8px;
    }
    
    .link-domain {
        word-break: break-all;
        white-space: normal;
    }
    
    .image-modal-close {
        top: 10px;
        right: 10px;
    }
}

/* Enhanced empty states */
.empty-state {
    background: white;
    border-radius: 8px;
    padding: 60px 20px;
    text-align: center;
    color: #878a8c;
    border: 1px solid #edeff1;
}

/* Avatar System Styles */
.user-avatar, .user-avatar-small {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    overflow: hidden;
    color: white;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.user-avatar {
    width: 32px;
    height: 32px;
    font-size: 14px;
}

.user-avatar-small {
    width: 20px;
    height: 20px;
    font-size: 10px;
}

.avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-initial {
    text-transform: uppercase;
    text-align: center;
    line-height: 1;
}

/* Avatar Color Styles */
.avatar-default {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.avatar-red {
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
}

.avatar-blue {
    background: linear-gradient(135deg, #4834d4, #686de0);
}

.avatar-green {
    background: linear-gradient(135deg, #00d2d3, #54a0ff);
}

.avatar-purple {
    background: linear-gradient(135deg, #a55eea, #8854d0);
}

.avatar-orange {
    background: linear-gradient(135deg, #fd9644, #f39c12);
}

.avatar-pink {
    background: linear-gradient(135deg, #ff9ff3, #f368e0);
}

.avatar-teal {
    background: linear-gradient(135deg, #26d0ce, #1abc9c);
}

.avatar-admin {
    background: linear-gradient(135deg, #fd79a8, #e84393);
    border: 2px solid #ffd700;
}

.online-indicator {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 12px;
    height: 12px;
    background: #00d26a;
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.user-avatar-small .online-indicator {
    width: 8px;
    height: 8px;
    border: 1px solid white;
    bottom: -1px;
    right: -1px;
}

/* Inline user info for thread listings */
.inline-user-info {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    vertical-align: middle;
}

.user-link {
    color: #0079d3;
    text-decoration: none;
    font-weight: 500;
}

.user-link:hover {
    text-decoration: underline;
}

/* Navigation user avatar adjustments */
.nav-user .user-avatar {
    margin-right: 8px;
}

/* Thread meta line adjustments */
.thread-meta-line {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #878a8c;
    margin-bottom: 4px;
    flex-wrap: wrap;
}

.thread-meta-line .inline-user-info {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* Responsive design */
@media (max-width: 768px) {
    .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 12px;
    }
    
    .user-avatar-small {
        width: 18px;
        height: 18px;
        font-size: 9px;
    }
    
    .online-indicator {
        width: 10px;
        height: 10px;
    }
    
    .user-avatar-small .online-indicator {
        width: 6px;
        height: 6px;
    }
}
</style>
{{end}}